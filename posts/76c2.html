<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>PX4架构 | BFaner</title><meta name="keywords" content="PX4"><meta name="author" content="帆小生,1257291642@qq.com"><meta name="copyright" content="帆小生"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="pixhawk大部分的资料都在官网里有说明，以下是PIXHAWK硬件、PX4软件、PX4开发手册的官方网站。 PIXHAWK硬件官网 https:&amp;#x2F;&amp;#x2F;pixhawk.org PX4软件官网 https:&amp;#x2F;&amp;#x2F;px4.io PX4软件用户手册 https:&amp;#x2F;&amp;#x2F;docs.px4.io&amp;#x2F;main&amp;#x2F;en PX"><link rel="shortcut icon" href="/img/%E5%A4%B4%E5%83%8F.jpg"><link rel="canonical" href="https://bfaner.github.io/posts/76c2"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":30,"position":"top","messagePrev":"这篇文章已经","messageNext":"天没更新了，内容有可能已经过时。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PX4架构',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-14 21:06:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><script async src="/css/categoryBar.js"></script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<link rel="stylesheet" href="/css/double-row.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/weibo/"><i class="fa-fw fas fa-comments"></i><span> 微博</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">BFaner</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/weibo/"><i class="fa-fw fas fa-comments"></i><span> 微博</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">PX4架构</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-24T06:42:24.000Z" title="发表于 2022-10-24 14:42:24">2022-10-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-14T13:06:23.982Z" title="更新于 2023-04-14 21:06:23">2023-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%88%AA%E7%A9%BA%E8%88%AA%E5%A4%A9/">航空航天</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%88%AA%E7%A9%BA%E8%88%AA%E5%A4%A9/PX4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">PX4学习笔记</a></span></div><div class="meta-secondline"></div></div></div><article class="post-content" id="article-container"><p>pixhawk大部分的资料都在官网里有说明，以下是PIXHAWK硬件、PX4软件、PX4开发手册的官方网站。</p>
<p><a target="_blank" rel="noopener" href="https://pixhawk.org">PIXHAWK硬件官网</a> <a target="_blank" rel="noopener" href="https://pixhawk.org">https://pixhawk.org</a></p>
<p><a target="_blank" rel="noopener" href="https://px4.io">PX4软件官网</a> <a target="_blank" rel="noopener" href="https://px4.io">https://px4.io</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.px4.io/main/en/">PX4软件用户手册</a> <a target="_blank" rel="noopener" href="https://docs.px4.io/main/en">https://docs.px4.io/main/en</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.px4.io/main/zh">PX4中文用户手册</a> <a target="_blank" rel="noopener" href="https://docs.px4.io/main/zh">https://docs.px4.io/main/zh</a></p>
<h1 id="硬件设备"><a href="#硬件设备" class="headerlink" title="硬件设备"></a>硬件设备</h1><p>【2021淘宝整理】</p>
<p>电脑：ThinkPad X1 Carbon 2020—ThinkPad官方旗舰店—12999 </p>
<p>仿真机：Speedgoat-Baseline-S—上海熠速信息技术有限公司—60000</p>
<p>飞控方案1：</p>
<ul>
<li>飞控pixhawk：雷迅CUAVV5+—CUAV雷迅创新—1499</li>
<li>GPS：雷迅UBLOX M8NGPS模块—CUAV雷迅创新—300</li>
<li>数传：雷迅CUAV pixhawk飞控数传 3DR数传模块—CUAV雷迅创新—278</li>
<li>空速计：CUAV雷迅PIX飞控空速计 差压传感器—CUAV雷迅创新—280</li>
</ul>
<p>飞控方案2：</p>
<ul>
<li>飞控pixhawk：HEX赫星Pixhawk2开源飞控—赫星旗舰店—2000</li>
<li>GPS：赫星Here3高精度无人机差分GPS(天空端+基站)—赫星旗舰店—3499</li>
<li>数传：赫星 RFD900x 高频率数传电台—赫星旗舰店—2000</li>
</ul>
<p>遥控器方案1：FUTABA T14SG—高安模型淘宝店—3100</p>
<p>遥控器方案2：FUTABA T18MZ—翼飞模型商行2号店—12588</p>
<p>接收机：FUTABA R7008SB 2.4G接收机—高安模型淘宝店—850</p>
<h1 id="PX4系统架构"><a href="#PX4系统架构" class="headerlink" title="PX4系统架构"></a>PX4系统架构</h1><h2 id="硬件运行模式"><a href="#硬件运行模式" class="headerlink" title="硬件运行模式"></a>硬件运行模式</h2><p>官网给出了两个典型运行模式：单独飞控、飞控+任务计算机。</p>
<h3 id="单独飞控"><a href="#单独飞控" class="headerlink" title="单独飞控"></a>单独飞控</h3><p><img src="76c2/image-20230406192646683.png" alt="image-20230406192646683" style="zoom:25%;" /></p>
<h3 id="飞控-任务计算机"><a href="#飞控-任务计算机" class="headerlink" title="飞控+任务计算机"></a>飞控+任务计算机</h3><p>飞控芯片能力弱，解算常规控制模式；任务计算机上可以搭载更复杂的算法， 比如防碰撞、图像识别等高级算法。</p>
<p><img src="76c2/image-20230406193931821.png" alt="image-20230406193931821" style="zoom:25%;" /></p>
<h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><p>PX4的软件运行提供 POSIX-API 的各种操作系统上（如 Linux、macOS、NuttX ）。</p>
<h3 id="Linux、macOS"><a href="#Linux、macOS" class="headerlink" title="Linux、macOS"></a>Linux、macOS</h3><p>在 Linux、macOS 上时，PX4在单个进程中运行，每个模块在自己的线程中运行。</p>
<h3 id="Nuttx"><a href="#Nuttx" class="headerlink" title="Nuttx"></a>Nuttx</h3><p>飞控板上首选操作系统为<strong>NuttX</strong>，Nuttx上有两种的方式运行模块。</p>
<ol>
<li><p>任务Tasks：</p>
<p>模块在它自己的任务中运行, 具有自己的堆栈和进程优先级。</p>
</li>
<li><p>工作队列Work queue tasks：</p>
<p>多个任务在同一堆栈上运行，与队列中的其他模块共享相同的堆栈和工作队列线程优先级。<code>top</code>不显示运行的任务，只显示队列本身。</p>
<p>在工作队列上运行模块的优点是它使用较少的 RAM，并可能导致更少的任务切换。缺点是工作队列任务不允许休眠或轮询邮件，或阻止 IO（例如从文件读取）。 长时间运行的任务（执行大量计算）可能还应在单独的任务或至少单独的工作队列中运行。</p>
</li>
</ol>
<h3 id="任务启动"><a href="#任务启动" class="headerlink" title="任务启动"></a>任务启动</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">independent_task = <span class="built_in">px4_task_spawn_cmd</span>(</span><br><span class="line">    <span class="string">&quot;commander&quot;</span>,                    <span class="comment">// Process name</span></span><br><span class="line">    SCHED_DEFAULT,                  <span class="comment">// Scheduling type (RR or FIFO)</span></span><br><span class="line">    SCHED_PRIORITY_DEFAULT + <span class="number">40</span>,    <span class="comment">// Scheduling priority</span></span><br><span class="line">    <span class="number">3600</span>,                           <span class="comment">// Stack size of the new task or thread</span></span><br><span class="line">    commander_thread_main,          <span class="comment">// Task (or thread) main function</span></span><br><span class="line">    (<span class="type">char</span> * <span class="type">const</span> *)&amp;argv[<span class="number">0</span>]        <span class="comment">// Void pointer to pass to the new task</span></span><br><span class="line">                                    <span class="comment">// (here the commandline arguments).</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure>
<h3 id="飞控启动的流程"><a href="#飞控启动的流程" class="headerlink" title="飞控启动的流程"></a>飞控启动的流程</h3><img src="/posts/76c2/image-20230408195254193.png" class="" title="image-20230408195254193">
<h1 id="PX4软件架构"><a href="#PX4软件架构" class="headerlink" title="PX4软件架构"></a>PX4软件架构</h1><h2 id="软件组成"><a href="#软件组成" class="headerlink" title="软件组成"></a>软件组成</h2><p>PX4 由两个主要部分组成：</p>
<ul>
<li><p><strong>中间件</strong> ，主要负责内部/外部通讯和硬件整合。包括了嵌入式传感器的驱动、通信、uORB。</p>
</li>
<li><p><strong>飞行控制栈</strong>（flight stack），负责主要的计算。主要包括状态估计和飞行控制系统。</p>
</li>
</ul>
<p><img src="76c2/e4527168dde4414cb63412485bda8d6a.png" alt="img" style="zoom:50%;" /></p>
<p>所有的 PX4 支持的无人机机型共用同一个代码库。 整个系统采用响应式(reactive)设计，这意味着：</p>
<ul>
<li>所有的功能都可以被分割成若干可替换、可重复使用的部件。</li>
<li>通过异步消息传递进行通信。</li>
<li>系统可以应对不同的工作负载。</li>
</ul>
<h2 id="开发环境搭建"><a href="#开发环境搭建" class="headerlink" title="开发环境搭建"></a>开发环境搭建</h2><h3 id="代码获取"><a href="#代码获取" class="headerlink" title="代码获取"></a>代码获取</h3><p>使用 git 拉取官方仓库的代码，尽量不要拉取最新的代码，使用-b拉取稳定版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/PX4/PX4-Autopilot.git -b v1.12.3</span><br></pre></td></tr></table></figure>
<h3 id="代码编译环境"><a href="#代码编译环境" class="headerlink" title="代码编译环境"></a>代码编译环境</h3><p>编译飞控固件，可以在Linux、Mac、Windows等环境中。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Target</th>
<th style="text-align:center">Linux (Ubuntu)</th>
<th style="text-align:center">Mac</th>
<th style="text-align:center">Windows</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>NuttX based hardware</strong>: <a target="_blank" rel="noopener" href="http://docs.px4.io/main/en/flight_controller/pixhawk_series.html">Pixhawk Series</a>, <a target="_blank" rel="noopener" href="http://docs.px4.io/main/en/complete_vehicles/crazyflie2.html">Crazyflie</a>, <a target="_blank" rel="noopener" href="http://docs.px4.io/main/en/complete_vehicles/intel_aero.html">Intel® Aero Ready to Fly Drone</a></td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
</tr>
<tr>
<td>Linux-based hardware: <a target="_blank" rel="noopener" href="http://docs.px4.io/main/en/flight_controller/raspberry_pi_navio2.html">Raspberry Pi 2/3</a></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>Simulation: <a target="_blank" rel="noopener" href="http://docs.px4.io/main/en/simulation/jmavsim.html">jMAVSim SITL</a></td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
</tr>
<tr>
<td>Simulation: <a target="_blank" rel="noopener" href="http://docs.px4.io/main/en/sim_gazebo_gz/">Gazebo SITL</a></td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
</tr>
<tr>
<td>Simulation: <a target="_blank" rel="noopener" href="http://docs.px4.io/main/en/sim_gazebo_classic/">Gazebo Classic SITL</a></td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
</tr>
<tr>
<td>Simulation: <a target="_blank" rel="noopener" href="http://docs.px4.io/main/en/simulation/ros_interface.html">ROS with Gazebo Classic</a></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>Simulation: ROS 2 with Gazebo</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
</div>
<p><strong>windows</strong> 环境中，使用VScode打开PX4代码文件夹。在VScode的拓展中使用<code>@recommended</code>，查看推荐的插件，其中包括了arm、docker、cmake、jinja、C++、python等工具，安装后即可进行编译。如果在windows上查看不编译，则只需要安装<code>cpptools</code>即可。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// See http://go.microsoft.com/fwlink/?LinkId=827846</span></span><br><span class="line">    <span class="comment">// for the documentation about the extensions.json format</span></span><br><span class="line">    <span class="attr">&quot;recommendations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;chiehyu.vscode-astyle&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;dan-c-underwood.arm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;fredericbonnet.cmake-test-adapter&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;github.vscode-pull-request-github&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;marus25.cortex-debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;ms-azuretools.vscode-docker&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;ms-iot.vscode-ros&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;ms-python.python&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;ms-vscode.cmake-tools&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;ms-vscode.cpptools&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;ms-vscode.cpptools-extension-pack&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;redhat.vscode-yaml&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;streetsidesoftware.code-spell-checker&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;twxs.cmake&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;uavcan.dsdl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;wholroyd.jinja&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;zixuanwang.linkerscript&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>PX4也推出了<strong>docker</strong>环境，也可以在docker中进行编译。只编译飞控使用，可以构建<code>px4-dev-nuttx-focal</code>的docker 环境，同样尽量不使用最新的环境，使用稳定的docker环境。</p>
<ul>
<li>px4io/px4-dev-base-focal<ul>
<li>px4io/px4-dev-nuttx-focal</li>
<li>px4io/px4-dev-simulation-focal<ul>
<li>px4io/px4-dev-ros-noetic<ul>
<li>px4io/px4-dev-ros2-foxy</li>
</ul>
</li>
</ul>
</li>
<li>px4io/px4-dev-ros2-rolling</li>
<li>px4io/px4-dev-ros2-galactic</li>
</ul>
</li>
</ul>
<h2 id="硬件与固件版本"><a href="#硬件与固件版本" class="headerlink" title="硬件与固件版本"></a>硬件与固件版本</h2><ul>
<li><a target="_blank" rel="noopener" href="http://docs.px4.io/main/zh/flight_controller/pixhawk-2.html">Pixhawk 2 (Cube Black) (FMUv3)</a>: <code>make px4_fmu-v3_default</code></li>
<li><a target="_blank" rel="noopener" href="http://docs.px4.io/main/zh/flight_controller/cuav_v5_plus.html">CUAV V5+ (FMUv5)</a>: <code>make px4_fmu-v5_default</code></li>
<li><a target="_blank" rel="noopener" href="http://docs.px4.io/main/zh/flight_controller/cuav_v5_nano.html">CUAV V5 nano (FMUv5)</a>: <code>make px4_fmu-v5_default</code></li>
</ul>
<h1 id="uORB介绍"><a href="#uORB介绍" class="headerlink" title="uORB介绍"></a>uORB介绍</h1><h2 id="uORB机制"><a href="#uORB机制" class="headerlink" title="uORB机制"></a>uORB机制</h2><p>消息的更新速率可以使用 <code>uorb top</code> 命令实时查看。</p>
<p><img src="76c2/image-20230408104008357.png" alt="image-20230408104008357" style="zoom:40%;" /></p>
<h2 id="uORB流程"><a href="#uORB流程" class="headerlink" title="uORB流程"></a>uORB流程</h2><ol>
<li><p>uORB话题发布者：公告(advertise)、发布(publish)。</p>
<p>发布流程：orb_advertise( ) - &gt; orb_publish( )</p>
</li>
<li><p>uORB话题接收者：订阅(subscribe)、查询(poll阻塞式等待或check更新)、复制(copy)。</p>
<p>接收流程：orb_subscribe( ) - &gt; orb_check( ) -&gt; orb_copy( )</p>
</li>
</ol>
<h2 id="uORB常用函数"><a href="#uORB常用函数" class="headerlink" title="uORB常用函数"></a>uORB常用函数</h2><h3 id="公告advertise"><a href="#公告advertise" class="headerlink" title="公告advertise"></a>公告advertise</h3><p><code>orb_advert_t orb_advertise(const struct orb_metadata \*meta, const void \*data)</code></p>
<blockquote>
<p>功能：公告发布者的主题；</p>
<p>说明：在发布主题之前是必须的；否则订阅者虽然能订阅，但是得不到数据；</p>
<p>参数：</p>
<blockquote>
<p>meta:uORB元对象，可以认为是主题id，一般是通过ORB_ID(主题名)来赋值;<br>data:指向一个已被初始化，发布者要发布的数据存储变量的指针；</p>
</blockquote>
<p>返回值：</p>
<blockquote>
<p>错误则返回ERROR;成功则返回一个可以发布主题的句柄；如果待发布的主题没有定义或声明则会返回-1，然后会将errno赋值为ENOENT;</p>
</blockquote>
</blockquote>
<p>公告(advertise)示例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">vehicle_attitude_s</span> att;</span><br><span class="line"><span class="built_in">memset</span>(&amp;att, <span class="number">0</span>, <span class="built_in">sizeof</span>(att));</span><br><span class="line"><span class="type">int</span> att_pub_fd = <span class="built_in">orb_advertise</span>(<span class="built_in">ORB_ID</span>(vehicle_attitude), &amp;att);</span><br></pre></td></tr></table></figure>
<h3 id="发布publish"><a href="#发布publish" class="headerlink" title="发布publish"></a>发布publish</h3><p><code>int orb_publish(const struct orb_metadata \*meta, orb_advert_t handle, const void \*data)</code></p>
<blockquote>
<p>功能：发布新数据到主题；</p>
<p>参数：</p>
<blockquote>
<p>meta: uORB元对象，可以认为是主题id，一般是通过ORB_ID(主题名)来赋值;<br>handle: orb_advertise函数返回的句柄；<br>data: 指向待发布数据的指针；</p>
</blockquote>
<p>返回值：</p>
<blockquote>
<p>OK表示成功；错误返回ERROR；否则则有根据的去设置errno;</p>
</blockquote>
</blockquote>
<p>发布(publish)示例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">orb_publish</span>(<span class="built_in">ORB_ID</span>(vehicle_attitude), att_pub_fd, &amp;att);</span><br></pre></td></tr></table></figure>
<h3 id="订阅subscribe"><a href="#订阅subscribe" class="headerlink" title="订阅subscribe"></a>订阅subscribe</h3><p><code>int orb_subscribe(const struct orb_metadata \*meta)</code></p>
<blockquote>
<p>功能：订阅主题（topic）;</p>
<p>说明：即使订阅的主题没有被公告，但是也能订阅成功；但是在这种情况下，却得不到数据，直到主题被公告；</p>
<p>参数：</p>
<blockquote>
<p>meta:uORB元对象，可以认为是主题id，一般是通过ORB_ID(主题名)来赋值；</p>
</blockquote>
<p>返回值：</p>
<blockquote>
<p>错误则返回ERROR;成功则返回一个可以读取数据、更新话题的句柄；如果待订阅的主题没有定义或声明则会返回-1，然后会将errno赋值为ENOENT;</p>
</blockquote>
</blockquote>
<p>订阅(subscribe)示例：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fd = <span class="built_in">orb_subscribe</span>(<span class="built_in">ORB_ID</span>(topicName));</span><br></pre></td></tr></table></figure></p>
<h3 id="检查check"><a href="#检查check" class="headerlink" title="检查check"></a>检查check</h3><p><code>int orb_check(int handle, bool \*updated)</code></p>
<blockquote>
<p>功能：订阅者可以用来检查一个主题在发布者上一次更新数据后，有没有订阅者调用过ob_copy来接收、处理过；</p>
<p>说明：如果主题在在被公告前就有人订阅，那么这个API将返回“not-updated”直到主题被公告。可以不用poll，只用这个函数实现数据的获取。</p>
<p>参数：</p>
<blockquote>
<p>handle:主题句柄；<br>updated:如果当最后一次更新的数据被获取了，检测到并设置updated为ture;</p>
</blockquote>
<p>返回值：</p>
<blockquote>
<p>OK表示检测成功；错误返回ERROR;否则则有根据的去设置errno;</p>
</blockquote>
</blockquote>
<p>检查(check)示例：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (PX4_OK != <span class="built_in">orb_check</span>(sfd, &amp;updated)) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;check(1) failed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (updated) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;spurious updated flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> updated;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">random_integer_data</span> rd;</span><br><span class="line"><span class="comment">/* check to see whether the topic has updated since the last time we read it */</span></span><br><span class="line"><span class="built_in">orb_check</span>(topic_handle, &amp;updated);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (updated) &#123;</span><br><span class="line">	<span class="comment">/* make a local copy of the updated data structure */</span></span><br><span class="line">	<span class="built_in">orb_copy</span>(<span class="built_in">ORB_ID</span>(random_integer), topic_handle, &amp;rd);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Random integer is now %d\n&quot;</span>, rd.r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="复制copy"><a href="#复制copy" class="headerlink" title="复制copy"></a>复制copy</h3><p><code>int orb_copy(const struct orb_metadata \*meta, int handle, void \*buffer)</code></p>
<blockquote>
<p>功能：从订阅的主题中获取数据并将数据保存到buffer中；</p>
<p>参数：</p>
<blockquote>
<p>meta:uORB元对象，可以认为是主题id，一般是通过ORB_ID(主题名)来赋值;<br>handle:订阅主题返回的句柄；<br>buffer:从主题中获取的数据；</p>
</blockquote>
<p>返回值：</p>
<blockquote>
<p>返回OK表示获取数据成功，错误返回ERROR;否则则有根据的去设置errno;</p>
</blockquote>
</blockquote>
<p>复制(copy)示例<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sensor_combined_s</span> raw;</span><br><span class="line"><span class="built_in">orb_copy</span>(<span class="built_in">ORB_ID</span>(sensor_combined), sensor_sub_fd, &amp;raw);</span><br></pre></td></tr></table></figure></p>
<h3 id="阻塞等待poll"><a href="#阻塞等待poll" class="headerlink" title="阻塞等待poll"></a>阻塞等待poll</h3><p><code>int poll(struct pollfd fds[], nfds_t nfds, int timeout)</code></p>
<blockquote>
<p>功能：监控文件描述符（多个）；</p>
<p>说明：timemout=0,poll()函数立即返回而不阻塞；timeout=INFTIM(-1),poll()会一直阻塞下去，直到检测到return &gt; 0；</p>
<p>参数：</p>
<blockquote>
<p>fds:struct pollfd结构类型的数组；<br>nfds:用于标记数组fds中的结构体元素的总数量；<br>timeout:是poll函数调用阻塞的时间，单位：毫秒；</p>
</blockquote>
<p>返回值：</p>
<blockquote>
<p>>0：数组fds中准备好读、写或出错状态的那些socket描述符的总数量；<br>==0:poll()函数会阻塞timeout所指定的毫秒时间长度之后返回;<br>-1:poll函数调用失败；同时会自动设置全局变量errno；</p>
</blockquote>
</blockquote>
<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><ol>
<li><p>获取主题优先级别</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = <span class="built_in">orb_priority</span>(handle,&amp;priority);</span><br></pre></td></tr></table></figure>
</li>
<li><p>检测一个主题是否存在</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = <span class="built_in">orb_exists</span>(<span class="built_in">ORB_ID</span>(vehicle_attitude),<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查一个主题最后的发布时间</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = <span class="built_in">orb_stat</span>(handle,time);</span><br></pre></td></tr></table></figure>
</li>
<li><p>取消订阅主题</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = <span class="built_in">orb_unsubscribe</span>(handle);</span><br></pre></td></tr></table></figure>
</li>
<li><p>同主题注册多个类似的驱动程序</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">orb_test</span> t;</span><br><span class="line">t.val = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> instance0;</span><br><span class="line"><span class="type">orb_advert_t</span> pfd0 = <span class="built_in">orb_advertise_multi</span>(<span class="built_in">ORB_ID</span>(orb_multitest), &amp;t, &amp;instance0, ORB_PRIO_MAX);</span><br></pre></td></tr></table></figure>
</li>
<li><p>订阅主题（topic）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sfd1 = <span class="built_in">orb_subscribe_multi</span>(<span class="built_in">ORB_ID</span>(orb_multitest), <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置订阅的最小时间间隔</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">orb_set_interval</span>(sensor_sub_fd, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uORB/topics/sensor_combined.h&gt;</span><span class="comment">//订阅传感器数据</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sensor_sub_fd = <span class="built_in">orb_subscribe</span>(<span class="built_in">ORB_ID</span>(sensor_combined));</span><br><span class="line"><span class="comment">//sensor_sub_fd是一个话题句柄，可用于非常有效地执行阻塞等待新数据。当前线程进入睡眠状态，一旦有新数据可用，调度程序就会自动唤醒该线程，在等待时不消耗任何CPU周期。为此，我们使用poll() POSIX系统调用。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* one could wait for multiple topics with this technique, just using one here */</span></span><br><span class="line"><span class="type">px4_pollfd_struct_t</span> fds[] = &#123;</span><br><span class="line">    &#123; .fd = sensor_sub_fd,   .events = POLLIN &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">/* wait for sensor update of 1 file descriptor for 1000 ms (1 second) */</span></span><br><span class="line">    <span class="type">int</span> poll_ret = <span class="built_in">px4_poll</span>(fds, <span class="number">1</span>, <span class="number">1000</span>);</span><br><span class="line">    ..</span><br><span class="line">    <span class="keyword">if</span> (fds[<span class="number">0</span>].revents &amp; POLLIN) &#123;</span><br><span class="line">        <span class="comment">/* obtained data for the first file descriptor */</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sensor_combined_s</span> raw;</span><br><span class="line">        <span class="comment">/* copy sensors raw data into local buffer */</span></span><br><span class="line">        <span class="built_in">orb_copy</span>(<span class="built_in">ORB_ID</span>(sensor_combined), sensor_sub_fd, &amp;raw);</span><br><span class="line">        <span class="built_in">PX4_INFO</span>(<span class="string">&quot;Accelerometer:\t%8.4f\t%8.4f\t%8.4f&quot;</span>,</span><br><span class="line">                    (<span class="type">double</span>)raw.accelerometer_m_s2[<span class="number">0</span>],</span><br><span class="line">                    (<span class="type">double</span>)raw.accelerometer_m_s2[<span class="number">1</span>],</span><br><span class="line">                    (<span class="type">double</span>)raw.accelerometer_m_s2[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uORB/topics/vehicle_attitude.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* advertise attitude topic */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">vehicle_attitude_s</span> att;</span><br><span class="line"><span class="built_in">memset</span>(&amp;att, <span class="number">0</span>, <span class="built_in">sizeof</span>(att));</span><br><span class="line"><span class="type">orb_advert_t</span> att_pub_fd = <span class="built_in">orb_advertise</span>(<span class="built_in">ORB_ID</span>(vehicle_attitude), &amp;att);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">	<span class="built_in">orb_publish</span>(<span class="built_in">ORB_ID</span>(vehicle_attitude), att_pub_fd, &amp;att);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="飞行控制栈"><a href="#飞行控制栈" class="headerlink" title="飞行控制栈"></a>飞行控制栈</h1><h2 id="主要组成"><a href="#主要组成" class="headerlink" title="主要组成"></a>主要组成</h2><p><img src="76c2/Center.png" alt="img" style="zoom:60%;" /></p>
<p><strong>决策导航部分</strong>：根据飞行器自身安全状态和接收到的命令，决定工作模式。<br><strong>位置姿态估计部分</strong>：根据传感器得到自身的位置和姿态信息，EKF。<br><strong>位置姿态控制部分</strong>：根据期望位置和姿态设计控制结构，TECS、L1、PID。<br><strong>控制器输出部分</strong>：mixer和执行器，pwm限幅。</p>
<h3 id="PX4代码列表"><a href="#PX4代码列表" class="headerlink" title="PX4代码列表"></a>PX4代码列表</h3><p><img src="76c2/代码列表.png" alt="源码列表" style="zoom:40%;" /></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>目录</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>NuttX</td>
<td>NuttX的系统库</td>
<td>一般不使用</td>
</tr>
<tr>
<td>Romfs</td>
<td>文件系统文件夹</td>
<td>启动脚本：src/Romfs/px4fmu_common/init.d</td>
</tr>
<tr>
<td>Cmake</td>
<td>Cmake的模板脚本</td>
<td>执行编译时，cmake调用</td>
</tr>
<tr>
<td>boards</td>
<td>各编译版本的cmake文件</td>
<td>执行编译时，cmake调用</td>
</tr>
<tr>
<td>Mavlink</td>
<td>MAvlink的库目录</td>
<td>修改和添加MAVLINLK消息ID</td>
</tr>
<tr>
<td>Msg</td>
<td>存放UORB消息主题</td>
<td>二次开发添加消息主题</td>
</tr>
<tr>
<td>Src</td>
<td>源码目录存放所有的源码</td>
<td>算法主要在src/modules、src/lib</td>
</tr>
<tr>
<td></td>
<td></td>
<td>src/drivers是驱动，src/Systemcmds是系统命令</td>
</tr>
</tbody>
</table>
</div>
<h2 id="Make解析"><a href="#Make解析" class="headerlink" title="Make解析"></a>Make解析</h2><p>整个编译过程： <strong>Make</strong> 调用了 <strong>CMake</strong>, 然后<strong>CMake</strong> 调用了<strong>Ninja</strong> 读取 <strong>CMakeLists.txt</strong> 文件生成编译配置文件, 然后<strong>CMake</strong> 再调用 <strong>Ninja</strong> 进行编译。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make px4_fmu-v3_default</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新建文件夹，并进入</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;/Firmware/build/px4_fmu-v3_default&quot;</span> </span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;/Firmware/build/px4_fmu-v3_default&quot;</span></span><br><span class="line"><span class="comment"># 判断是否执行cmake；执行cmake时，读取CMakeLists.txt，生成ninja的编译配置文件</span></span><br><span class="line">cmake ./ -G<span class="string">&quot;ninja&quot;</span> -DCONFIG=px4_fmu-v3_default</span><br><span class="line"><span class="comment"># 执行 cmake --build ，编译生成</span></span><br><span class="line">cmake --build ./ -- -j4</span><br></pre></td></tr></table></figure>
<h3 id="Cmake流程"><a href="#Cmake流程" class="headerlink" title="Cmake流程"></a>Cmake流程</h3><p>在根目录执行cmake，读取cmakelists.txt的配置。根据设置，对其子文件夹下包含的cmakelists.txt读取，进而读取所有的cmakelists.txt。因此，在根目录cmakelists.txt中包含需要编译的文件夹，在每个文件夹的cmakelist.stxt中包含所有需要编译的文件。</p>
<p>新增文件后，需要先增加cmakelists，并执行cmake才能在qt中显示。</p>
<h3 id="Cmakelists部分解析"><a href="#Cmakelists部分解析" class="headerlink" title="Cmakelists部分解析"></a>Cmakelists部分解析</h3><p>根据根目录的cmakelists.txt解析，如下：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">104</span> <span class="keyword">set</span>(PX4_SOURCE_DIR <span class="string">&quot;$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&quot;</span>)<span class="comment">#设置PX4_SOURCE_DIR的变量</span></span><br><span class="line"><span class="number">105</span> <span class="keyword">list</span>(APPEND CMAKE_MODULE_PATH <span class="variable">$&#123;PX4_SOURCE_DIR&#125;</span>/cmake)<span class="comment">#添加cmake的文件夹为搜索路径</span></span><br><span class="line">...</span><br><span class="line"><span class="number">137</span> <span class="keyword">set</span>(CONFIG <span class="string">&quot;px4_sitl_default&quot;</span> CACHE <span class="keyword">STRING</span> <span class="string">&quot;desired configuration&quot;</span>)<span class="comment">#默认为仿真</span></span><br><span class="line"><span class="number">139</span> <span class="keyword">include</span>(px4_add_module)</span><br><span class="line"><span class="number">142</span> <span class="keyword">include</span>(px4_config)</span><br><span class="line"><span class="number">143</span> <span class="keyword">include</span>(px4_add_board)</span><br></pre></td></tr></table></figure>
<p>cmake文件夹下包含了如下的cmake文件，只需要关注用到的几个cmake即可</p>
<p><img src="76c2/image-20230408153150100.png" alt="image-20230408153150100" style="zoom:50%;" /></p>
<ul>
<li><p>如<code>px4_add_module.cmake</code>定义了一种格式的解析操作，会将如下格式的cmakelists.txt文件解析，生成Makefile。在“编译第一个程序”便使用了这个cmakelists.txt模板。</p>
  <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">px4_add_module(MODULE &lt;<span class="keyword">string</span>&gt;</span><br><span class="line">    MAIN &lt;<span class="keyword">string</span>&gt;</span><br><span class="line">    [ STACK_MAIN &lt;<span class="keyword">string</span>&gt; ]</span><br><span class="line">    [ STACK_MAX &lt;<span class="keyword">string</span>&gt; ]</span><br><span class="line">    [ COMPILE_FLAGS &lt;<span class="keyword">list</span>&gt; ]</span><br><span class="line">    [ INCLUDES &lt;<span class="keyword">list</span>&gt; ]</span><br><span class="line">    [ DEPENDS &lt;<span class="keyword">string</span>&gt; ]</span><br><span class="line">    [ SRCS &lt;<span class="keyword">list</span>&gt; ]</span><br><span class="line">    [ MODULE_CONFIG &lt;<span class="keyword">list</span>&gt; ]</span><br><span class="line">    [ EXTERNAL ]</span><br><span class="line">    [ DYNAMIC ]</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
</li>
<li><p>如<code>px4_config.cmake</code>会将参数nuttx_px4fmu-v3_default解析为<code>boards\px4\fmu-v3\default.cmake</code>。</p>
</li>
<li><p>如<code>px4_add_board.cmake</code>定义了可选平台的cmakelists.txt模板。</p>
<ul>
<li><p>如<code>boards\px4\fmu-v3\default.cmake</code>定义了所包含的所有应用。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">px4_add_board(</span><br><span class="line">	PLATFORM nuttx</span><br><span class="line">	VENDOR px4</span><br><span class="line">	MODEL fmu-v3</span><br><span class="line">	LABEL default</span><br><span class="line">	TOOLCHAIN arm-none-eabi</span><br><span class="line">	ARCHITECTURE cortex-m4</span><br><span class="line">	CONSTRAINED_MEMORY</span><br><span class="line">	ROMFSROOT px4fmu_common</span><br><span class="line">	IO px4_io-v2_default</span><br><span class="line">	UAVCAN_INTERFACES <span class="number">2</span></span><br><span class="line">	SERIAL_PORTS</span><br><span class="line">		GPS1:/dev/ttyS3</span><br><span class="line">		TEL1:/dev/ttyS1</span><br><span class="line">		TEL2:/dev/ttyS2</span><br><span class="line">		TEL4:/dev/ttyS6</span><br><span class="line">	DRIVERS</span><br><span class="line">		adc/ads1115</span><br><span class="line">		adc/board_adc</span><br><span class="line">		barometer <span class="comment"># all available barometer drivers</span></span><br><span class="line">		batt_smbus</span><br><span class="line">		camera_capture</span><br><span class="line">		camera_trigger</span><br><span class="line">		differential_pressure <span class="comment"># all available differential pressure drivers</span></span><br><span class="line">		distance_sensor <span class="comment"># all available distance sensor drivers</span></span><br><span class="line">		dshot</span><br><span class="line">		gps</span><br><span class="line">		heater</span><br><span class="line">		<span class="comment">#imu # all available imu drivers</span></span><br><span class="line">		imu/analog_devices/adis16448</span><br><span class="line">		imu/l3gd20</span><br><span class="line">		imu/lsm303d</span><br><span class="line">		imu/invensense/icm20608g</span><br><span class="line">		imu/invensense/icm20948 <span class="comment"># required for ak09916 mag</span></span><br><span class="line">		imu/invensense/mpu6000</span><br><span class="line">		imu/invensense/mpu9250</span><br><span class="line">		irlock</span><br><span class="line">		lights <span class="comment"># all available light drivers</span></span><br><span class="line">		magnetometer <span class="comment"># all available magnetometer drivers</span></span><br><span class="line">		optical_flow <span class="comment"># all available optical flow drivers</span></span><br><span class="line">		osd</span><br><span class="line">		pca9685</span><br><span class="line">		pca9685_pwm_out</span><br><span class="line">		<span class="comment">#power_monitor/ina226</span></span><br><span class="line">		<span class="comment">#protocol_splitter</span></span><br><span class="line">		pwm_input</span><br><span class="line">		pwm_out_sim</span><br><span class="line">		pwm_out</span><br><span class="line">		px4io</span><br><span class="line">		roboclaw</span><br><span class="line">		rpm</span><br><span class="line">		smart_battery/batmon</span><br><span class="line">		telemetry <span class="comment"># all available telemetry drivers</span></span><br><span class="line">		tone_alarm</span><br><span class="line">		uavcan</span><br><span class="line">	MODULES</span><br><span class="line">		airspeed_selector</span><br><span class="line">		attitude_estimator_q</span><br><span class="line">		battery_status</span><br><span class="line">		camera_feedback</span><br><span class="line">		commander</span><br><span class="line">		dataman</span><br><span class="line">		ekf2</span><br><span class="line">		esc_battery</span><br><span class="line">		events</span><br><span class="line">		flight_mode_manager</span><br><span class="line">		fw_att_control</span><br><span class="line">		fw_pos_control_l1</span><br><span class="line">		gyro_calibration</span><br><span class="line">		gyro_fft</span><br><span class="line">		land_detector</span><br><span class="line">		landing_target_estimator</span><br><span class="line">		load_mon</span><br><span class="line">		local_position_estimator</span><br><span class="line">		logger</span><br><span class="line">		mavlink</span><br><span class="line">		mc_att_control</span><br><span class="line">		mc_hover_thrust_estimator</span><br><span class="line">		mc_pos_control</span><br><span class="line">		mc_rate_control</span><br><span class="line">		<span class="comment">#micrortps_bridge</span></span><br><span class="line">		navigator</span><br><span class="line">		rc_update</span><br><span class="line">		rover_pos_control</span><br><span class="line">		sensors</span><br><span class="line">		sih</span><br><span class="line">		temperature_compensation</span><br><span class="line">		uuv_att_control</span><br><span class="line">		uuv_pos_control</span><br><span class="line">		vmount</span><br><span class="line">		vtol_att_control</span><br><span class="line">	SYSTEMCMDS</span><br><span class="line">		bl_update</span><br><span class="line">		<span class="comment">#dmesg</span></span><br><span class="line">		dumpfile</span><br><span class="line">		esc_calib</span><br><span class="line">		gpio</span><br><span class="line">		hardfault_log</span><br><span class="line">		i2cdetect</span><br><span class="line">		led_control</span><br><span class="line">		mft</span><br><span class="line">		mixer</span><br><span class="line">		motor_ramp</span><br><span class="line">		motor_test</span><br><span class="line">		mtd</span><br><span class="line">		nshterm</span><br><span class="line">		param</span><br><span class="line">		perf</span><br><span class="line">		pwm</span><br><span class="line">		reboot</span><br><span class="line">		reflect</span><br><span class="line">		sd_bench</span><br><span class="line">		serial_test</span><br><span class="line">		system_time</span><br><span class="line">		top</span><br><span class="line">		topic_listener</span><br><span class="line">		tune_control</span><br><span class="line">		uorb</span><br><span class="line">		usb_connected</span><br><span class="line">		ver</span><br><span class="line">		work_queue</span><br><span class="line">	EXAMPLES</span><br><span class="line">		fake_gps</span><br><span class="line">		<span class="comment">#fake_imu</span></span><br><span class="line">		<span class="comment">#fake_magnetometer</span></span><br><span class="line">		<span class="comment">#fixedwing_control # Tutorial code from https://px4.io/dev/example_fixedwing_control</span></span><br><span class="line">		<span class="comment">#hello</span></span><br><span class="line">		<span class="comment">#hwtest # Hardware test</span></span><br><span class="line">		<span class="comment">#matlab_csv_serial</span></span><br><span class="line">		<span class="comment">#px4_mavlink_debug # Tutorial code from http://dev.px4.io/en/debug/debug_values.html</span></span><br><span class="line">		<span class="comment">#px4_simple_app # Tutorial code from http://dev.px4.io/en/apps/hello_sky.html</span></span><br><span class="line">		<span class="comment">#rover_steering_control # Rover example app</span></span><br><span class="line">		<span class="comment">#uuv_example_app</span></span><br><span class="line">		<span class="comment">#work_item</span></span><br><span class="line">	)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>继续解析根目录的cmakelists.txt</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># libs、modules</span></span><br><span class="line"><span class="number">123</span> <span class="keyword">define_property</span>(GLOBAL PROPERTY PX4_MODULE_LIBRARIES</span><br><span class="line"><span class="number">124</span>                  BRIEF_DOCS <span class="string">&quot;PX4 module libs&quot;</span></span><br><span class="line"><span class="number">125</span>                  FULL_DOCS <span class="string">&quot;List of all PX4 module libraries&quot;</span></span><br><span class="line"><span class="number">126</span>                  )</span><br><span class="line"><span class="number">127</span> </span><br><span class="line"><span class="number">128</span> <span class="keyword">define_property</span>(GLOBAL PROPERTY PX4_MODULE_PATHS</span><br><span class="line"><span class="number">129</span>                  BRIEF_DOCS <span class="string">&quot;PX4 module paths&quot;</span></span><br><span class="line"><span class="number">130</span>                  FULL_DOCS <span class="string">&quot;List of paths to all PX4 modules&quot;</span></span><br><span class="line"><span class="number">131</span>                  )</span><br></pre></td></tr></table></figure>
<p>剩下的是驱动、其他子模块、外部项目。 </p>
<h3 id="qt使用cmake"><a href="#qt使用cmake" class="headerlink" title="qt使用cmake"></a>qt使用cmake</h3><p>ubuntu上使用qt阅读时，需要先cmake的工程创建成CodeBlocks工程，-G表示编译器。在px4源码Firmware平级目录下新建<code>Firmware-build</code>文件夹。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Firmware-build</span><br><span class="line">cmake ../Firmware -G <span class="string">&quot;CodeBlocks - Unix Makefiles&quot;</span> [-DCONFIG=nuttx_px4fmu-v3_default]<span class="comment">#默认为仿真版本</span></span><br></pre></td></tr></table></figure>
<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><div class="table-container">
<table>
<thead>
<tr>
<th>makefile语法</th>
<th>例子</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>wildcard</td>
<td>$(wildcard *.git)</td>
<td>通用符，当前路径下的所有.git结尾的文件；</td>
</tr>
<tr>
<td>MAKECMDGOALS</td>
<td>$(MAKECMDGOALS)</td>
<td>（用户输入的）命令行参数；</td>
</tr>
<tr>
<td>firstword</td>
<td>$(firstword <text>)</td>
<td>取字符串的第一个单词，lastword同理取最后一个单词；</td>
</tr>
<tr>
<td>wordlist</td>
<td>$(wordlist <s>,<e>,<text>)</td>
<td>取字符串函数，$(word 1,5， text)表示取text的第1个到第5个单词字串</td>
</tr>
<tr>
<td>words</td>
<td>$(words <text>)</td>
<td>统计字符串中单词数目；</td>
</tr>
<tr>
<td>MAKEFILE_LIST</td>
<td>$(MAKEFILE_LIST)</td>
<td>包含所有被执行的makefile文件列表，可以通过这个变量查看哪些makefile被执行。当前的makefile总是在列表的最后。</td>
</tr>
<tr>
<td>realpath</td>
<td>$(realpath <text>)</td>
<td>获取文件的路径</td>
</tr>
<tr>
<td>shell</td>
<td>$(shell <text>)</td>
<td>在 subshell 中执行命令, 例:$(shell echo “Hello world”) ,会输出 Hello world</td>
</tr>
<tr>
<td>subst</td>
<td>$(subst, <from>, <to>, <text>)</td>
<td>截取字符串</td>
</tr>
<tr>
<td>.PHONY</td>
<td>.PHONY: <text></td>
<td><code>Targets that do not refer to filles but are just actions are called phony targets</code> (执行一些命令但不生成目标文件的 编译目标叫做 Phony target).</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make px4_fmu-v3_default</span><br></pre></td></tr></table></figure>
<ol>
<li><p>读入参数<code>px4_fmu-v3_default</code>，同时读取当前目录下的<code>Makefile</code>。</p>
</li>
<li><p><code>Makefile</code>的<code>.PHONY</code>中，包含参数<code>px4_fmu-v3_default</code>的定义如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 215-216 获取所有boards/*/*.cmake文件</span></span><br><span class="line"><span class="comment"># Get a list of all config targets boards/*/*.cmake</span></span><br><span class="line">ALL_CONFIG_TARGETS := <span class="variable">$(<span class="built_in">shell</span> find boards -maxdepth 3 -mindepth 3 ! -name &#x27;*common*&#x27; ! -name &#x27;*sdflight*&#x27; -name &#x27;*.cmake&#x27; -print | sed -e &#x27;s|boards\/||&#x27; | sed -e &#x27;s|\.cmake||&#x27; | sed -e &#x27;s|\/|_|g&#x27; | <span class="built_in">sort</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 222-236 所有的编译方式和默认编译方式</span></span><br><span class="line"><span class="comment"># All targets.</span></span><br><span class="line"><span class="variable">$(ALL_CONFIG_TARGETS)</span>:</span><br><span class="line">	@<span class="variable">$(<span class="built_in">eval</span> PX4_CONFIG = <span class="variable">$@</span>)</span></span><br><span class="line">	@<span class="variable">$(<span class="built_in">eval</span> CMAKE_ARGS += -DCONFIG=<span class="variable">$(PX4_CONFIG)</span>)</span></span><br><span class="line">	@<span class="variable">$(<span class="built_in">call</span> cmake-build,<span class="variable">$(PX4_CONFIG)</span><span class="variable">$(BUILD_DIR_SUFFIX)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Filter for only default targets to allow omiting the &quot;_default&quot; postfix</span></span><br><span class="line">CONFIG_TARGETS_DEFAULT := <span class="variable">$(<span class="built_in">patsubst</span> %_default,%,$(<span class="built_in">filter</span> %_default,<span class="variable">$(ALL_CONFIG_TARGETS)</span>)</span>)</span><br><span class="line"><span class="variable">$(CONFIG_TARGETS_DEFAULT)</span>:</span><br><span class="line">	@<span class="variable">$(<span class="built_in">eval</span> PX4_CONFIG = <span class="variable">$@</span>_default)</span></span><br><span class="line">	@<span class="variable">$(<span class="built_in">eval</span> CMAKE_ARGS += -DCONFIG=<span class="variable">$(PX4_CONFIG)</span>)</span></span><br><span class="line">	@<span class="variable">$(<span class="built_in">call</span> cmake-build,<span class="variable">$(PX4_CONFIG)</span><span class="variable">$(BUILD_DIR_SUFFIX)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">all_config_targets: <span class="variable">$(ALL_CONFIG_TARGETS)</span></span></span><br><span class="line"><span class="section">all_default_targets: <span class="variable">$(CONFIG_TARGETS_DEFAULT)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 245</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all px4_sitl_default all_config_targets all_default_targets</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>$(ALL_CONFIG_TARGET)</code>和<code>$(CONFIG_TARGETS_DEFAULT)</code> 包含了 <code>px4_fmu-v3_default</code>，后面出现的规则会覆盖之前出现的规则，因此所以<code>px4_fmu-v3_default</code> 的 <strong>recipes</strong> 为</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(CONFIG_TARGETS_DEFAULT)</span>:</span><br><span class="line">	@<span class="variable">$(<span class="built_in">eval</span> PX4_CONFIG = <span class="variable">$@</span>_default)</span></span><br><span class="line">	@<span class="variable">$(<span class="built_in">eval</span> CMAKE_ARGS += -DCONFIG=<span class="variable">$(PX4_CONFIG)</span>)</span></span><br><span class="line">	@<span class="variable">$(<span class="built_in">call</span> cmake-build,<span class="variable">$(PX4_CONFIG)</span><span class="variable">$(BUILD_DIR_SUFFIX)</span>)</span></span><br><span class="line">	<span class="comment">#$(BUILD_DIR_SUFFIX)根据前面定义为 _reply 或者 为空</span></span><br></pre></td></tr></table></figure>
<p>替换变量后，即为</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_TARGETS_DEFAULT := px4_fmu-v3 <span class="comment">#分割变量</span></span><br><span class="line"><span class="section">px4_fmu-v3:</span></span><br><span class="line">	@<span class="variable">$(<span class="built_in">eval</span> CMAKE_ARGS += -DCONFIG=px4_fmu-v3_default)</span></span><br><span class="line">	@<span class="variable">$(<span class="built_in">call</span> cmake-build,px4_fmu-v3_default)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>即调用<code>cmake-build</code>，增加编译选项<code>-DCONFIG=px4_fmu-v3_default</code>，并传入参数<code>px4_fmu-v3_default</code>。 </p>
</li>
<li><p><code>cmake_build</code> 的定义如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">define</span> cmake-build</span><br><span class="line">	<span class="comment"># SRC_DIR为makefile的目录，即根目录；$(1)为传入的第一个参数</span></span><br><span class="line">	<span class="comment"># BUILD_DIR = &quot;/Firmware/build/px4_fmu-v3_default&quot;</span></span><br><span class="line">	<span class="variable">$(<span class="built_in">eval</span> BUILD_DIR = &quot;<span class="variable">$(SRC_DIR)</span>/build/$(1)</span><span class="string">&quot;)</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	# 调用cmake-cache-check，检查CMAKE_ARGS是否与build_DIR中缓存中已配置的选项匹配</span></span><br><span class="line"><span class="string">	$(call cmake-cache-check)</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	# 如果是&quot;</span>Ninja<span class="string">&quot;编译器，并且存在&quot;</span>Makefile<span class="string">&quot;，【删除build下生成的目录】</span></span><br><span class="line"><span class="string">	if [ <span class="variable">$(PX4_CMAKE_GENERATOR)</span> = &quot;</span>Ninja<span class="string">&quot; ] &amp;&amp; [ -e <span class="variable">$(BUILD_DIR)</span>/Makefile ]; then rm -rf <span class="variable">$(BUILD_DIR)</span>; fi</span></span><br><span class="line"><span class="string">	# 如果是&quot;</span>Ninja<span class="string">&quot;编译器，并且不存在&quot;</span>build.ninja<span class="string">&quot;，【删除build下生成的目录】</span></span><br><span class="line"><span class="string">	if [ <span class="variable">$(PX4_CMAKE_GENERATOR)</span> = &quot;</span>Ninja<span class="string">&quot; ] &amp;&amp; [ ! -f <span class="variable">$(BUILD_DIR)</span>/build.ninja ]; then rm -rf <span class="variable">$(BUILD_DIR)</span>; fi</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	# 如果不存在cmake缓存，或者cmake设置不一样，则【使用&quot;</span>Ninja<span class="string">&quot;编译器重新执行cmake，在Firmware下生成ninja的编译配置文件】，否则，删除build下生成的目录</span></span><br><span class="line"><span class="string">	# cmake ./ -G&quot;</span>ninja<span class="string">&quot; -DCONFIG=px4_fmu-v3_default</span></span><br><span class="line"><span class="string">	if [ ! -e <span class="variable">$(BUILD_DIR)</span>/CMakeCache.txt ] || [ <span class="variable">$(CMAKE_CACHE_CHECK)</span> ]; then \</span></span><br><span class="line"><span class="string">		mkdir -p <span class="variable">$(BUILD_DIR)</span> \</span></span><br><span class="line"><span class="string">		&amp;&amp; cd <span class="variable">$(BUILD_DIR)</span> \</span></span><br><span class="line"><span class="string">		&amp;&amp; cmake &quot;</span><span class="variable">$(SRC_DIR)</span><span class="string">&quot; -G&quot;</span><span class="variable">$(PX4_CMAKE_GENERATOR)</span><span class="string">&quot; <span class="variable">$(CMAKE_ARGS)</span> \</span></span><br><span class="line"><span class="string">		|| (rm -rf <span class="variable">$(BUILD_DIR)</span>); \</span></span><br><span class="line"><span class="string">	fi</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	# 执行cmake --build，参数为并行数，<span class="variable">$(ARGS)</span>为剩余的参数</span></span><br><span class="line"><span class="string">	cmake --build <span class="variable">$(BUILD_DIR)</span> -- <span class="variable">$(PX4_MAKE_ARGS)</span> <span class="variable">$(ARGS)</span></span></span><br><span class="line"><span class="string">endef</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>补充</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 59-60 设置默认编译目标</span></span><br><span class="line"><span class="comment"># explicity set default build target</span></span><br><span class="line"><span class="section">all: px4_sitl_default</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 74-75 读取用户输入参数，FIRST_ARG为第一个字符，ARGS为剩余字符</span></span><br><span class="line">FIRST_ARG := <span class="variable">$(<span class="built_in">firstword</span> <span class="variable">$(MAKECMDGOALS)</span>)</span></span><br><span class="line">ARGS := <span class="variable">$(<span class="built_in">wordlist</span> 2,$(words <span class="variable">$(MAKECMDGOALS)</span>)</span>,<span class="variable">$(MAKECMDGOALS)</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### 79-80 设置开多少jobs，进行并行执行</span></span><br><span class="line">MAKE_PID := <span class="variable">$(<span class="built_in">shell</span> echo $$PPID)</span></span><br><span class="line">j := <span class="variable">$(<span class="built_in">shell</span> ps T | sed -n &#x27;s|.*<span class="variable">$(MAKE_PID)</span>.*<span class="variable">$(MAKE)</span>.* \(-j\|--jobs\)</span> *\([0-9][0-9]*\).*|\2|p&#x27;)</span><br><span class="line"></span><br><span class="line"><span class="comment">### 85-121 设置是否用构建工具ninja生成CMake文件</span></span><br><span class="line">NINJA_BIN := ninja</span><br><span class="line"><span class="keyword">ifndef</span> NO_NINJA_BUILD</span><br><span class="line">	NINJA_BUILD := <span class="variable">$(<span class="built_in">shell</span> <span class="variable">$(NINJA_BIN)</span> --version 2&gt;/dev/null)</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">ifndef</span> NINJA_BUILD</span><br><span class="line">		NINJA_BIN := ninja-build</span><br><span class="line">		NINJA_BUILD := <span class="variable">$(<span class="built_in">shell</span> <span class="variable">$(NINJA_BIN)</span> --version 2&gt;/dev/null)</span></span><br><span class="line">	<span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifdef</span> NINJA_BUILD</span><br><span class="line">	PX4_CMAKE_GENERATOR := Ninja</span><br><span class="line">	PX4_MAKE := <span class="variable">$(NINJA_BIN)</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">ifdef</span> VERBOSE</span><br><span class="line">		PX4_MAKE_ARGS := -v</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		PX4_MAKE_ARGS :=</span><br><span class="line">	<span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Only override ninja default if -j is set.</span></span><br><span class="line">	<span class="keyword">ifneq</span> (<span class="variable">$(j)</span>,)</span><br><span class="line">		PX4_MAKE_ARGS := <span class="variable">$(PX4_MAKE_ARGS)</span> -j<span class="variable">$(j)</span></span><br><span class="line">	<span class="keyword">endif</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">ifdef</span> SYSTEMROOT</span><br><span class="line">		<span class="comment"># Windows</span></span><br><span class="line">		PX4_CMAKE_GENERATOR := <span class="string">&quot;MSYS\ Makefiles&quot;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		PX4_CMAKE_GENERATOR := <span class="string">&quot;Unix\ Makefiles&quot;</span></span><br><span class="line">	<span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># For non-ninja builds we default to -j4</span></span><br><span class="line">	j := <span class="variable">$(<span class="built_in">or</span> <span class="variable">$(j)</span>,4)</span></span><br><span class="line">	PX4_MAKE = <span class="variable">$(MAKE)</span></span><br><span class="line">	PX4_MAKE_ARGS = -j<span class="variable">$(j)</span> --no-print-directory</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 123 获取当前makefile的路径</span></span><br><span class="line">SRC_DIR := <span class="variable">$(<span class="built_in">shell</span> dirname &quot;$(<span class="built_in">realpath</span> $(<span class="built_in">lastword</span> <span class="variable">$(MAKEFILE_LIST)</span>)</span>)<span class="string">&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### 132-161 传递cmake参数,包括是否包括外部模块,及 cmake 的build 的类型</span></span><br><span class="line"><span class="string"># additional config parameters passed to cmake</span></span><br><span class="line"><span class="string">ifdef EXTERNAL_MODULES_LOCATION</span></span><br><span class="line"><span class="string">	CMAKE_ARGS += -DEXTERNAL_MODULES_LOCATION:STRING=<span class="variable">$(EXTERNAL_MODULES_LOCATION)</span></span></span><br><span class="line"><span class="string">endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ifdef PX4_CMAKE_BUILD_TYPE</span></span><br><span class="line"><span class="string">	CMAKE_ARGS += -DCMAKE_BUILD_TYPE=$&#123;PX4_CMAKE_BUILD_TYPE&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	# Address Sanitizer</span></span><br><span class="line"><span class="string">	ifdef PX4_ASAN</span></span><br><span class="line"><span class="string">		CMAKE_ARGS += -DCMAKE_BUILD_TYPE=AddressSanitizer</span></span><br><span class="line"><span class="string">	endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	# Memory Sanitizer</span></span><br><span class="line"><span class="string">	ifdef PX4_MSAN</span></span><br><span class="line"><span class="string">		CMAKE_ARGS += -DCMAKE_BUILD_TYPE=MemorySanitizer</span></span><br><span class="line"><span class="string">	endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	# Thread Sanitizer</span></span><br><span class="line"><span class="string">	ifdef PX4_TSAN</span></span><br><span class="line"><span class="string">		CMAKE_ARGS += -DCMAKE_BUILD_TYPE=ThreadSanitizer</span></span><br><span class="line"><span class="string">	endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	# Undefined Behavior Sanitizer</span></span><br><span class="line"><span class="string">	ifdef PX4_UBSAN</span></span><br><span class="line"><span class="string">		CMAKE_ARGS += -DCMAKE_BUILD_TYPE=UndefinedBehaviorSanitizer</span></span><br><span class="line"><span class="string">	endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">endif</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="编写第一个程序"><a href="#编写第一个程序" class="headerlink" title="编写第一个程序"></a>编写第一个程序</h2><p><a target="_blank" rel="noopener" href="http://docs.px4.io/master/en/modules/hello_sky.html">官网教程</a> <a target="_blank" rel="noopener" href="http://docs.px4.io/master/en/modules/hello_sky.html">http://docs.px4.io/master/en/modules/hello_sky.html</a></p>
<h3 id="编写函数"><a href="#编写函数" class="headerlink" title="编写函数"></a>编写函数</h3><p>/Firmware/src/<strong>examples</strong>，建立<strong>hello_sky</strong>文件夹，在该<strong>hello_sky</strong>文件夹下建立两个文件：<strong>CMakeLists.txt</strong>，<strong>hello_zyw.c</strong></p>
<ul>
<li><p>CMakeLists.txt</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">px4_add_module(</span><br><span class="line">	//如果根目录是/Firmware/src/modules，则这里使用modules__hello_sky</span><br><span class="line">    MODULE examples__hello_sky //hello_sky前面有两个下划线</span><br><span class="line"></span><br><span class="line">    //c程序里的主函数为hello_main</span><br><span class="line">    MAIN hello</span><br><span class="line"></span><br><span class="line">    //所包含的.c文件为hello_zyw.c，若有子文件，要全部写入</span><br><span class="line">    SRCS</span><br><span class="line">    	hello_zyw.c</span><br><span class="line"></span><br><span class="line">    DEPENDS</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>hello_zyw.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__EXPORT <span class="type">int</span> <span class="title function_">hello_main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span>;<span class="comment">//声明主函数为hello_main</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">hello_main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span><span class="comment">//主函数</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello sky!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;goodbye\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在默认的cmake中添加该文件夹，V1.10.2版的cmake位置在：src/Firmware/boards/px4/fmu-v3/default.cmake</p>
<p>在EXAMPLES下面加入hello_sky【如果上面在modules中，则在MODULES中加】</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>1.在/Firmware下打开终端，先make clean，再make px4_fmu-v3_default</p>
<p>2.在/Firmware会生成一个build文件夹，打开/build/px4_fmu-v3_default，为编译生成的文件</p>
<p>3.固件为px4_fmu-v3_default.px4</p>
<h3 id="烧固件"><a href="#烧固件" class="headerlink" title="烧固件"></a>烧固件</h3><p>将上述生成的px4_fmu-v3_default.px4复制到桌面，打开QGC，选择固件，插入数据线，选择“用户自定义”，确定，选择px4_fmu-v3_default.px4，等待烧写完毕。</p>
<h3 id="订阅消息的函数"><a href="#订阅消息的函数" class="headerlink" title="订阅消息的函数"></a>订阅消息的函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file px4_simple_app.c</span></span><br><span class="line"><span class="comment"> * Minimal application example for PX4 autopilot</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @author Example User &lt;mail@example.com&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;px4_config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;px4_tasks.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;px4_posix.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uORB/uORB.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uORB/topics/sensor_combined.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uORB/topics/vehicle_attitude.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//main函数必须命名为&lt;module_name&gt;_main并从模块中导出（__EXPORT）。</span></span><br><span class="line"><span class="function">__EXPORT <span class="type">int</span> <span class="title">px4_simple_app_main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>;<span class="comment">//这是主函数的声明，必须要有</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">px4_simple_app_main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">PX4_INFO</span>(<span class="string">&quot;Hello Sky!&quot;</span>);<span class="comment">// PX4_INFO为打印函数，用printf也可以</span></span><br><span class="line">	<span class="comment">//PX4_INFO相当于PX4 shell的printf(包含在px4_platform_common/log.h中)。有不同的日志级别:PX4_INFO、PX4_WARN、PX4_ERR、PX4_DEBUG。警告和错误被添加到ULog并在飞行检查(Flight Review)中显示。</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* subscribe to sensor_combined topic 订阅 */</span></span><br><span class="line">	<span class="type">int</span> sensor_sub_fd = <span class="built_in">orb_subscribe</span>(<span class="built_in">ORB_ID</span>(sensor_combined));</span><br><span class="line">	<span class="comment">/* limit the update rate to 5 Hz */</span></span><br><span class="line">	<span class="built_in">orb_set_interval</span>(sensor_sub_fd, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* advertise attitude topic 公告*/</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">vehicle_attitude_s</span> att;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;att, <span class="number">0</span>, <span class="built_in">sizeof</span>(att));</span><br><span class="line">	<span class="comment">//memset:作用是在一段内存块中填充某个给定的值，它对较大的结构体或数组进行清零操作的一种最快方法</span></span><br><span class="line">	<span class="type">orb_advert_t</span> att_pub = <span class="built_in">orb_advertise</span>(<span class="built_in">ORB_ID</span>(vehicle_attitude), &amp;att);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* one could wait for multiple topics with this technique, just using one here */</span></span><br><span class="line">	<span class="comment">//可以在此等待多个主题</span></span><br><span class="line">	<span class="type">px4_pollfd_struct_t</span> fds[] = &#123;</span><br><span class="line">		&#123; .fd = sensor_sub_fd,   .events = POLLIN &#125;,</span><br><span class="line">		<span class="comment">/* there could be more file descriptors here, in the form like:</span></span><br><span class="line"><span class="comment">		 * &#123; .fd = other_sub_fd,   .events = POLLIN &#125;,</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> error_counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">		<span class="comment">/* wait for sensor update of 1 file descriptor for 1000 ms (1 second) */</span></span><br><span class="line">		<span class="comment">//等待1000ms获取数据</span></span><br><span class="line">		<span class="type">int</span> poll_ret = <span class="built_in">px4_poll</span>(fds, <span class="number">1</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* handle the poll result */</span></span><br><span class="line">		<span class="keyword">if</span> (poll_ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">/* this means none of our providers is giving us data */</span></span><br><span class="line">			<span class="built_in">PX4_ERR</span>(<span class="string">&quot;Got no data within a second&quot;</span>);</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (poll_ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">/* this is seriously bad - should be an emergency */</span></span><br><span class="line">			<span class="keyword">if</span> (error_counter &lt; <span class="number">10</span> || error_counter % <span class="number">50</span> == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">/* use a counter to prevent flooding (and slowing us down) 用一个计数器来防止崩溃并减慢我们的速度*/</span></span><br><span class="line">				<span class="built_in">PX4_ERR</span>(<span class="string">&quot;ERROR return value from poll(): %d&quot;</span>, poll_ret);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			error_counter++;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;          <span class="comment">//有数据</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (fds[<span class="number">0</span>].revents &amp; POLLIN) &#123;</span><br><span class="line">				<span class="comment">/* obtained data for the first file descriptor 获取了第一个文件描述符的数据 */</span></span><br><span class="line">				<span class="keyword">struct</span> sensor_combined_s raw;</span><br><span class="line">				<span class="comment">/* copy sensors raw data into local buffer 复制原始传感器数据到buffer*/</span></span><br><span class="line">				<span class="built_in">orb_copy</span>(<span class="built_in">ORB_ID</span>(sensor_combined), sensor_sub_fd, &amp;raw);</span><br><span class="line">				<span class="built_in">PX4_INFO</span>(<span class="string">&quot;Accelerometer:\t%8.4f\t%8.4f\t%8.4f&quot;</span>,</span><br><span class="line">					 (<span class="type">double</span>)raw.accelerometer_m_s2[<span class="number">0</span>],</span><br><span class="line">					 (<span class="type">double</span>)raw.accelerometer_m_s2[<span class="number">1</span>],</span><br><span class="line">					 (<span class="type">double</span>)raw.accelerometer_m_s2[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* set att and publish this information for other apps</span></span><br><span class="line"><span class="comment">				 the following does not have any meaning, it&#x27;s just an example</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">				<span class="comment">//att赋值，并发布给其他apps【示例，无意义】</span></span><br><span class="line">				att.q[<span class="number">0</span>] = raw.accelerometer_m_s2[<span class="number">0</span>];</span><br><span class="line">				att.q[<span class="number">1</span>] = raw.accelerometer_m_s2[<span class="number">1</span>];</span><br><span class="line">				att.q[<span class="number">2</span>] = raw.accelerometer_m_s2[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">				<span class="built_in">orb_publish</span>(<span class="built_in">ORB_ID</span>(vehicle_attitude), att_pub, &amp;att);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* there could be more file descriptors here, in the form like:</span></span><br><span class="line"><span class="comment">			 * if (fds[1..n].revents &amp; POLLIN) &#123;&#125;</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">PX4_INFO</span>(<span class="string">&quot;exiting&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://bfaner.github.io">帆小生</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://bfaner.github.io/posts/76c2.html">https://bfaner.github.io/posts/76c2.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://bfaner.github.io" target="_blank">BFaner</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PX4/">PX4</a></div><div class="post_share"><div class="social-share" data-image="/posts/76c2/pixhawk.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2392.html"><img class="prev-cover" src="/img/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">C语言编译过程</div></div></a></div><div class="next-post pull-right"><a href="/posts/a927.html"><img class="next-cover" src="/posts/a927/%E4%BB%93%E5%BA%93%E8%AE%BE%E7%BD%AE.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">博客及主题安装</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/47e3.html" title="PX4二次开发"><img class="cover" src="/img/cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-03</div><div class="title">PX4二次开发</div></div></a></div><div><a href="/posts/9262.html" title="串级PID原理及调参"><img class="cover" src="/posts/9262/%E7%8A%B6%E6%80%81%E7%A9%BA%E9%97%B4%E6%A8%A1%E5%9E%8B.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-27</div><div class="title">串级PID原理及调参</div></div></a></div><div><a href="/posts/fa89.html" title="px4半物理仿真"><img class="cover" src="/img/cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-15</div><div class="title">px4半物理仿真</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">帆小生</div><div class="author-info__description">Because we can</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Bfaner"><i class="fab fa-github"></i><span>联系我</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E8%AE%BE%E5%A4%87"><span class="toc-number">1.</span> <span class="toc-text">硬件设备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PX4%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">PX4系统架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">硬件运行模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E7%8B%AC%E9%A3%9E%E6%8E%A7"><span class="toc-number">2.1.1.</span> <span class="toc-text">单独飞控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A3%9E%E6%8E%A7-%E4%BB%BB%E5%8A%A1%E8%AE%A1%E7%AE%97%E6%9C%BA"><span class="toc-number">2.1.2.</span> <span class="toc-text">飞控+任务计算机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.2.</span> <span class="toc-text">操作系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E3%80%81macOS"><span class="toc-number">2.2.1.</span> <span class="toc-text">Linux、macOS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nuttx"><span class="toc-number">2.2.2.</span> <span class="toc-text">Nuttx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%90%AF%E5%8A%A8"><span class="toc-number">2.2.3.</span> <span class="toc-text">任务启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A3%9E%E6%8E%A7%E5%90%AF%E5%8A%A8%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.4.</span> <span class="toc-text">飞控启动的流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PX4%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">PX4软件架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E7%BB%84%E6%88%90"><span class="toc-number">3.1.</span> <span class="toc-text">软件组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.2.</span> <span class="toc-text">开发环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%8E%B7%E5%8F%96"><span class="toc-number">3.2.1.</span> <span class="toc-text">代码获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="toc-number">3.2.2.</span> <span class="toc-text">代码编译环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E4%B8%8E%E5%9B%BA%E4%BB%B6%E7%89%88%E6%9C%AC"><span class="toc-number">3.3.</span> <span class="toc-text">硬件与固件版本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#uORB%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.</span> <span class="toc-text">uORB介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#uORB%E6%9C%BA%E5%88%B6"><span class="toc-number">4.1.</span> <span class="toc-text">uORB机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uORB%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">uORB流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uORB%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">4.3.</span> <span class="toc-text">uORB常用函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E5%91%8Aadvertise"><span class="toc-number">4.3.1.</span> <span class="toc-text">公告advertise</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83publish"><span class="toc-number">4.3.2.</span> <span class="toc-text">发布publish</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E9%98%85subscribe"><span class="toc-number">4.3.3.</span> <span class="toc-text">订阅subscribe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5check"><span class="toc-number">4.3.4.</span> <span class="toc-text">检查check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6copy"><span class="toc-number">4.3.5.</span> <span class="toc-text">复制copy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E7%AD%89%E5%BE%85poll"><span class="toc-number">4.3.6.</span> <span class="toc-text">阻塞等待poll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%87%BD%E6%95%B0"><span class="toc-number">4.3.7.</span> <span class="toc-text">其他函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.4.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A3%9E%E8%A1%8C%E6%8E%A7%E5%88%B6%E6%A0%88"><span class="toc-number">5.</span> <span class="toc-text">飞行控制栈</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E7%BB%84%E6%88%90"><span class="toc-number">5.1.</span> <span class="toc-text">主要组成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PX4%E4%BB%A3%E7%A0%81%E5%88%97%E8%A1%A8"><span class="toc-number">5.1.1.</span> <span class="toc-text">PX4代码列表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Make%E8%A7%A3%E6%9E%90"><span class="toc-number">5.2.</span> <span class="toc-text">Make解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Cmake%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.1.</span> <span class="toc-text">Cmake流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cmakelists%E9%83%A8%E5%88%86%E8%A7%A3%E6%9E%90"><span class="toc-number">5.2.2.</span> <span class="toc-text">Cmakelists部分解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#qt%E4%BD%BF%E7%94%A8cmake"><span class="toc-number">5.2.3.</span> <span class="toc-text">qt使用cmake</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Makefile"><span class="toc-number">5.2.4.</span> <span class="toc-text">Makefile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%A8%8B%E5%BA%8F"><span class="toc-number">5.3.</span> <span class="toc-text">编写第一个程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%87%BD%E6%95%B0"><span class="toc-number">5.3.1.</span> <span class="toc-text">编写函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91"><span class="toc-number">5.3.2.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%A7%E5%9B%BA%E4%BB%B6"><span class="toc-number">5.3.3.</span> <span class="toc-text">烧固件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">5.3.4.</span> <span class="toc-text">订阅消息的函数</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 帆小生</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>