<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>QGC地面站 | BFaner</title><meta name="author" content="帆小生,1257291642@qq.com"><meta name="copyright" content="帆小生"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="以下是QGC、QGC用户手册、QGC开发手册的官方网站。修改链接里en&amp;#x2F;zh，修改可切换英&amp;#x2F;中文 QGC官网 http:&amp;#x2F;&amp;#x2F;qgroundcontrol.com&amp;#x2F; QGC用户手册 https:&amp;#x2F;&amp;#x2F;docs.qgroundcontrol.com&amp;#x2F;master&amp;#x2F;zh&amp;#x2F;index.html QGC开发手册"><link rel="shortcut icon" href="/img/%E5%A4%B4%E5%83%8F.jpg"><link rel="canonical" href="https://bfaner.github.io/posts/fb19"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":30,"position":"top","messagePrev":"这篇文章已经","messageNext":"天没更新了，内容有可能已经过时。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'QGC地面站',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-26 16:53:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><script async src="/css/categoryBar.js"></script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<link rel="stylesheet" href="/css/double-row.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/weibo/"><i class="fa-fw fas fa-comments"></i><span> 微博</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">BFaner</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/weibo/"><i class="fa-fw fas fa-comments"></i><span> 微博</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">QGC地面站</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-11-12T08:59:45.000Z" title="发表于 2021-11-12 16:59:45">2021-11-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-26T08:53:32.213Z" title="更新于 2023-04-26 16:53:32">2023-04-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%88%AA%E7%A9%BA%E8%88%AA%E5%A4%A9/">航空航天</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%88%AA%E7%A9%BA%E8%88%AA%E5%A4%A9/PX4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">PX4学习笔记</a></span></div><div class="meta-secondline"></div></div></div><article class="post-content" id="article-container"><p>以下是QGC、QGC用户手册、QGC开发手册的官方网站。修改链接里en/zh，修改可切换英/中文</p>
<p><a target="_blank" rel="noopener" href="http://qgroundcontrol.com/">QGC官网</a> <a target="_blank" rel="noopener" href="http://qgroundcontrol.com/">http://qgroundcontrol.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.qgroundcontrol.com/master/en/index.html">QGC用户手册</a> <a target="_blank" rel="noopener" href="https://docs.qgroundcontrol.com/master/zh/index.html">https://docs.qgroundcontrol.com/master/zh/index.html</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.qgroundcontrol.com/master/en/index.html">QGC开发手册</a> <a target="_blank" rel="noopener" href="https://dev.qgroundcontrol.com/master/zh/index.html">https://dev.qgroundcontrol.com/master/zh/index.html</a></p>
<h1 id="代码获取"><a href="#代码获取" class="headerlink" title="代码获取"></a>代码获取</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QGC版本：V4.1.7</span><br><span class="line">QT安装：5.15.2</span><br><span class="line">• Windows: MSVC 2019 64 bit</span><br><span class="line">• MacOS: macOS</span><br><span class="line">• Linux: Desktop gcc 64-bit</span><br><span class="line">• All:</span><br><span class="line">	○ Qt Charts</span><br><span class="line">	○ Android ARMv7 (to build Android)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QGC版本：V3.5.6</span><br><span class="line">QT安装：5.11.0</span><br><span class="line">• Windows: MSVC 2015 32 bit</span><br><span class="line">• MacOS: macOS</span><br><span class="line">• Linux: Desktop gcc 64-bit</span><br><span class="line">• All:</span><br><span class="line">	○ Qt Charts</span><br><span class="line">	○ Android ARMv7 (to build Android)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/mavlink/qgroundcontrol.git -b v4.1.7 --recursive</span><br><span class="line"><span class="comment">#github.com.cnpmjs.org镜像源已失效，最后使用魔法完成下载</span></span><br><span class="line"><span class="comment">#【可在后边加后缀-b Stable_V3.5.6，即下载稳定版3.5.6】</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#更新子模块【--recursive包含子文件夹】</span></span><br><span class="line">git submodule <span class="built_in">sync</span> --recursive<span class="comment">#自动更新子模块</span></span><br><span class="line">git submodule init &amp;&amp; git submodule update<span class="comment">#更新子模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#为解决更新子模块慢、无法更新等问题，修改源【修改.gitmodule】</span></span><br><span class="line">url = https://github.com/PX4/GpsDrivers.git</span><br></pre></td></tr></table></figure>
<p>QT各版本下载：<a target="_blank" rel="noopener" href="https://download.qt.io/archive/qt">https://download.qt.io/archive/qt</a></p>
<ol>
<li><p>打开在线安装工具</p>
<p>用户注册时，一定要选择个人开发者，否则无法安装免费版本。</p>
<p>5.15之后，不再提供离线安装，只能在线安装/下载源码编译<br>下载在线安装工具：<a target="_blank" rel="noopener" href="https://www.qt.io/download-qt-installer">https://www.qt.io/download-qt-installer</a></p>
<p><code>.\qt-unified-windows-x64-4.5.2-online.exe --mirror https://mirrors.aliyun.com/qt</code></p>
</li>
<li><p>“选择组件”，要先选择archive，筛选后，才能看到之前版本的QT</p>
</li>
<li><p>展开QT，选择5.15.2，选择对应组件<br><code>MSVC 2019 64 bit、Qt Charts、Qt Creator</code><br>安装后，启动QT，一直没有反应；查询各种攻略，都不行；最后想到Matlab也是如此，需要把AMD Radeon(TM) Graphics禁用，但是我只有这一个核显，，。只能用CPU硬跑了。</p>
</li>
<li><p>我电脑装了VS2015，使用<code>MSVC 2015 64 bit</code>，编译QGC，不通过。无奈换VS2019</p>
<p>在官网历史版本中，选择Visual Studio Community 2019 (version 16.11)下载【需要登录微软账户】，同样也是一个在线安装工具。<a target="_blank" rel="noopener" href="https://visualstudio.microsoft.com/zh-hans/vs/older-downloads/">https://visualstudio.microsoft.com/zh-hans/vs/older-downloads/</a></p>
<p>使用Debug、Release编译均通过，QGC正常运行。</p>
</li>
</ol>
<h2 id="编译安装包"><a href="#编译安装包" class="headerlink" title="编译安装包"></a>编译安装包</h2><p><a target="_blank" rel="noopener" href="https://dev.qgroundcontrol.com/master/zh/getting_started/">https://dev.qgroundcontrol.com/master/zh/getting_started/</a></p>
<ul>
<li><p>Windows需要安装 <a target="_blank" rel="noopener" href="https://sourceforge.net/projects/nsis/">NSIS</a></p>
<p><img src="fb19/image-20230426164122531.png" alt="image-20230426164122531" style="zoom:35%;" /></p>
</li>
<li><p>设置qmake，增加<code>CONFIG+=installer</code></p>
</li>
</ul>
<p><img src="fb19/image-20230426163628529.png" alt="image-20230426163628529" style="zoom:40%;" /></p>
<ul>
<li>编译结束后，自动打包压缩exe文件</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th><img src="fb19/image-20230426165138975.png" alt="image-20230426165138975" style="zoom:30%;" /></th>
<th><img src="fb19/image-20230426165226443.png" alt="image-20230426165226443" style="zoom:35%;" /></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
</div>
<h1 id="日志处理"><a href="#日志处理" class="headerlink" title="日志处理"></a>日志处理</h1><h2 id="filghtplot"><a href="#filghtplot" class="headerlink" title="filghtplot"></a>filghtplot</h2><p>①打开flightplot.jar</p>
<p>②打开日志ulg</p>
<p>③在Fields List中选择需要的数据，或者，打开之前设置好的数据模式</p>
<h2 id="pyulog转excel文件"><a href="#pyulog转excel文件" class="headerlink" title="pyulog转excel文件"></a>pyulog转excel文件</h2><p>①安装pyulog    <code>https://github.com/PX4/pyulog</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/PX4/pyulog.git</span><br><span class="line"></span><br><span class="line">python setup.py build install</span><br></pre></td></tr></table></figure>
<p>②在日志所在的文件夹输入命令<code>ulog2csv test.ulg</code>，在该文件夹中生成一系列.csv文件</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>位置</th>
<th>test_vehicle_gps_position_0.csv</th>
</tr>
</thead>
<tbody>
<tr>
<td>HOME点</td>
<td>test_home_position_0.csv</td>
</tr>
<tr>
<td>空速</td>
<td>test_airspeed_0.csv</td>
</tr>
<tr>
<td>姿态角</td>
<td>test_vehicle_attitude_0.csv</td>
</tr>
<tr>
<td>角速度、加速度</td>
<td>test_sensor_combined_0.csv</td>
</tr>
</tbody>
</table>
</div>
<h1 id="代码记录"><a href="#代码记录" class="headerlink" title="代码记录"></a>代码记录</h1><h2 id="V3-5-6-HIL启动流程"><a href="#V3-5-6-HIL启动流程" class="headerlink" title="V3.5.6-HIL启动流程"></a>V3.5.6-HIL启动流程</h2><h3 id="main-cc中创建界面"><a href="#main-cc中创建界面" class="headerlink" title="main.cc中创建界面"></a><code>main.cc</code>中创建界面</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	QGCApplication* app = <span class="keyword">new</span> <span class="built_in">QGCApplication</span>(argc, argv, runUnitTests);<span class="comment">//line231</span></span><br><span class="line">	<span class="keyword">if</span> (!app-&gt;_initForNormalAppBoot()) &#123;<span class="comment">//line276</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="QGCApplication-cc中初始化各界面"><a href="#QGCApplication-cc中初始化各界面" class="headerlink" title="QGCApplication.cc中初始化各界面"></a><code>QGCApplication.cc</code>中初始化各界面</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> QGCApplication::_initForNormalAppBoot()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">toolbox</span>()-&gt;<span class="built_in">corePlugin</span>()-&gt;<span class="built_in">createRootWindow</span>(_qmlAppEngine);<span class="comment">//line480--地图、五大界面等模块</span></span><br><span class="line">    MainWindow* mainWindow = MainWindow::_create();<span class="comment">//line489--界面的其他版块，如菜单栏</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>附：主界面初始化介绍—加载qml</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QQmlApplicationEngine* <span class="title">QGCCorePlugin::createRootWindow</span><span class="params">(QObject *parent)</span><span class="comment">//line288</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QQmlApplicationEngine* pEngine = <span class="keyword">new</span> <span class="built_in">QQmlApplicationEngine</span>(parent);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将qgroundcontrol.qrc/qml加入到搜索路径</span></span><br><span class="line">    pEngine-&gt;<span class="built_in">addImportPath</span>(<span class="string">&quot;qrc:/qml&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注册了一个名为“joystickManager”的 QML上下文的全局可见属性， 能在QML中调用(QML调用C++的一种形式)</span></span><br><span class="line">    pEngine-&gt;<span class="built_in">rootContext</span>()-&gt;<span class="built_in">setContextProperty</span>(<span class="string">&quot;joystickManager&quot;</span>, <span class="built_in">qgcApp</span>()-&gt;<span class="built_in">toolbox</span>()-&gt;<span class="built_in">joystickManager</span>());</span><br><span class="line">    pEngine-&gt;<span class="built_in">rootContext</span>()-&gt;<span class="built_in">setContextProperty</span>(<span class="string">&quot;debugMessageModel&quot;</span>, AppMessages::<span class="built_in">getModel</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//加载url的QML根文件，立即创建了由本地文件urls定义的对象树。此为UI显示的根目录</span></span><br><span class="line">    pEngine-&gt;<span class="built_in">load</span>(<span class="built_in">QUrl</span>(<span class="built_in">QStringLiteral</span>(<span class="string">&quot;qrc:/qml/MainWindowNative.qml&quot;</span>)));</span><br><span class="line">    <span class="keyword">return</span> pEngine;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="MainWindow-cc创建MainWindow"><a href="#MainWindow-cc创建MainWindow" class="headerlink" title="MainWindow.cc创建MainWindow"></a><code>MainWindow.cc</code>创建<code>MainWindow</code></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MainWindow* MainWindow::_create()</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">MainWindow</span>();</span><br><span class="line">    <span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line">MainWindow::<span class="built_in">MainWindow</span>()</span><br><span class="line">&#123;</span><br><span class="line">    _ui.<span class="built_in">setupUi</span>(<span class="keyword">this</span>);<span class="comment">//创建MainWindow的界面--line133</span></span><br><span class="line">    <span class="built_in">configureWindowName</span>();<span class="comment">//名字</span></span><br><span class="line">    _showAdvancedUIChanged(<span class="built_in">qgcApp</span>()-&gt;<span class="built_in">toolbox</span>()-&gt;<span class="built_in">corePlugin</span>()-&gt;<span class="built_in">showAdvancedUI</span>());<span class="comment">//bf--创建菜单页--line165</span></span><br><span class="line">    _buildCommonWidgets();<span class="comment">//bf--创建菜单里的小部件--line173</span></span><br><span class="line">    <span class="built_in">connectCommonActions</span>();<span class="comment">//链接槽函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建菜单里的小部件"><a href="#创建菜单里的小部件" class="headerlink" title="创建菜单里的小部件"></a>创建菜单里的小部件</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *rgDockWidgetNames[] = &#123;<span class="comment">//line74</span></span><br><span class="line">    <span class="string">&quot;MAVLink Inspector&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Custom Command&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Onboard Files&quot;</span>,</span><br><span class="line">    <span class="string">&quot;HIL Config&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Analyze&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> MainWindow::_buildCommonWidgets(<span class="type">void</span>)<span class="comment">//line269，创建菜单里的小部件</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>, end = <span class="built_in">ARRAY_SIZE</span>(rgDockWidgetNames); i &lt; end; i++) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* pDockWidgetName = rgDockWidgetNames[i];</span><br><span class="line">        <span class="comment">// Add to menu</span></span><br><span class="line">        QAction* action = <span class="keyword">new</span> <span class="built_in">QAction</span>(pDockWidgetName, <span class="keyword">this</span>);</span><br><span class="line">        <span class="built_in">connect</span>(action, &amp;QAction::triggered, <span class="keyword">this</span>, &amp;MainWindow::_showDockWidgetAction);<span class="comment">//链接action与槽函数</span></span><br><span class="line">        _ui.menuWidgets-&gt;<span class="built_in">addAction</span>(action);<span class="comment">//将action添加到menuWidgets的动作中</span></span><br><span class="line">        _mapName2Action[pDockWidgetName] = action;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> MainWindow::_showDockWidgetAction(<span class="type">bool</span> show)<span class="comment">//line346，点击action的槽函数</span></span><br><span class="line">&#123;</span><br><span class="line">    _showDockWidget(rgDockWidgetNames[action-&gt;<span class="built_in">data</span>().<span class="built_in">toInt</span>()], show);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> MainWindow::_showDockWidget(<span class="type">const</span> QString&amp; name, <span class="type">bool</span> show)<span class="comment">//line292，控制小部件的显隐</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 只有第一次点击后，才创建对应的小部件，节省内存</span></span><br><span class="line">    <span class="keyword">if</span> (!_mapName2DockWidget.<span class="built_in">contains</span>(name)) &#123;<span class="comment">//是否已经创建</span></span><br><span class="line">        <span class="keyword">if</span>(!_createInnerDockWidget(name)) &#123;<span class="comment">//bf--创建小窗口</span></span><br><span class="line">            <span class="keyword">return</span>;<span class="comment">//创建失败，返回</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    QGCDockWidget* dockWidget = _mapName2DockWidget[name];</span><br><span class="line">    dockWidget-&gt;<span class="built_in">setVisible</span>(show);</span><br><span class="line">    _mapName2Action[name]-&gt;<span class="built_in">setChecked</span>(show);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> MainWindow::_createInnerDockWidget(<span class="type">const</span> QString&amp; widgetName)<span class="comment">//line310，真正创建应用的函数(首次点击菜单，才进入)</span></span><br><span class="line">&#123;</span><br><span class="line">    QGCDockWidget* widget = <span class="literal">nullptr</span>;</span><br><span class="line">    QAction *action = _mapName2Action[widgetName];</span><br><span class="line">    <span class="keyword">if</span>(action) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(action-&gt;<span class="built_in">data</span>().<span class="built_in">toInt</span>()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MAVLINK_INSPECTOR:</span><br><span class="line">                widget = <span class="keyword">new</span> <span class="built_in">QGCMAVLinkInspector</span>(widgetName, action, <span class="built_in">qgcApp</span>()-&gt;<span class="built_in">toolbox</span>()-&gt;<span class="built_in">mavlinkProtocol</span>(),<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CUSTOM_COMMAND:</span><br><span class="line">                widget = <span class="keyword">new</span> <span class="built_in">CustomCommandWidget</span>(widgetName, action, <span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ONBOARD_FILES:</span><br><span class="line">                widget = <span class="keyword">new</span> <span class="built_in">QGCUASFileViewMulti</span>(widgetName, action, <span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> HIL_CONFIG:</span><br><span class="line">                widget = <span class="keyword">new</span> <span class="built_in">HILDockWidget</span>(widgetName, action, <span class="keyword">this</span>);<span class="comment">//bf--HIL小窗口</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ANALYZE:</span><br><span class="line">                widget = <span class="keyword">new</span> <span class="built_in">Linecharts</span>(widgetName, action, _mavLinkDecoderInstance(), <span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(widget) &#123;</span><br><span class="line">            _mapName2DockWidget[widgetName] = widget;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> widget != <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="新建HIL小窗口"><a href="#新建HIL小窗口" class="headerlink" title="新建HIL小窗口"></a>新建HIL小窗口</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HILDockWidget::<span class="built_in">HILDockWidget</span>(<span class="type">const</span> QString&amp; title, QAction* action, QWidget *parent)</span><br><span class="line">    : <span class="built_in">MultiVehicleDockWidget</span>(title, action, parent)<span class="comment">//line14,继承多机处理的父类</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">init</span>();<span class="comment">//针对多机模式，筛选到当前飞机后，会再进入下面的新建QGCHilConfiguration</span></span><br><span class="line">    <span class="built_in">loadSettings</span>();</span><br><span class="line">&#125;</span><br><span class="line">QWidget* HILDockWidget::_newVehicleWidget(Vehicle* vehicle, QWidget* parent)<span class="comment">//line27</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">QGCHilConfiguration</span>(vehicle, parent);<span class="comment">//bf--新建HIL小窗口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MultiVehicleDockWidget::init</span><span class="params">(<span class="type">void</span>)</span><span class="comment">//line29</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QmlObjectListModel* vehicles = <span class="built_in">qgcApp</span>()-&gt;<span class="built_in">toolbox</span>()-&gt;<span class="built_in">multiVehicleManager</span>()-&gt;<span class="built_in">vehicles</span>();<span class="comment">//针对多机控制，为每一个飞机创建对象</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;vehicles-&gt;<span class="built_in">count</span>(); i++) &#123;</span><br><span class="line">        _vehicleAdded(<span class="built_in">qobject_cast</span>&lt;Vehicle*&gt;(vehicles-&gt;<span class="built_in">get</span>(i)));<span class="comment">//bf--添加小窗口</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">qgcApp</span>()-&gt;<span class="built_in">toolbox</span>()-&gt;<span class="built_in">multiVehicleManager</span>()-&gt;<span class="built_in">activeVehicle</span>()) &#123;</span><br><span class="line">        _activeVehicleChanged(<span class="built_in">qgcApp</span>()-&gt;<span class="built_in">toolbox</span>()-&gt;<span class="built_in">multiVehicleManager</span>()-&gt;<span class="built_in">activeVehicle</span>());<span class="comment">//触发信号，切换为对应飞机的组件</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> MultiVehicleDockWidget::_vehicleAdded(Vehicle* vehicle)<span class="comment">//line57</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> id = vehicle-&gt;<span class="built_in">id</span>();</span><br><span class="line">    <span class="keyword">if</span> (!_vehicleWidgets.<span class="built_in">contains</span>(id)) &#123;</span><br><span class="line">        QWidget* vehicleWidget = _newVehicleWidget(vehicle, _ui-&gt;stackedWidget);<span class="comment">//bf--新建小窗口</span></span><br><span class="line">        _vehicleWidgets[id] = vehicleWidget;</span><br><span class="line">        _ui-&gt;stackedWidget-&gt;<span class="built_in">addWidget</span>(vehicleWidget);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">QGCHilConfiguration::<span class="built_in">QGCHilConfiguration</span>(Vehicle* vehicle, QWidget *parent)</span><br><span class="line">    : <span class="built_in">QWidget</span>(parent)</span><br><span class="line">    , _vehicle(vehicle)</span><br><span class="line">    , <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::QGCHilConfiguration)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);<span class="comment">//bf--终于启动界面，这是一个通用的界面</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// XXX its quite wrong that this is implicitely a factory</span></span><br><span class="line">    <span class="comment">// class, but this is something to clean up for later.</span></span><br><span class="line">    <span class="comment">// 这是一个隐含的工厂类，这是完全错误的，但这是稍后要清理的内容。</span></span><br><span class="line"></span><br><span class="line">    QSettings settings;</span><br><span class="line">    settings.<span class="built_in">beginGroup</span>(<span class="string">&quot;QGC_HILCONFIG&quot;</span>);</span><br><span class="line">    <span class="type">int</span> i = settings.<span class="built_in">value</span>(<span class="string">&quot;SIMULATOR_INDEX&quot;</span>, <span class="number">-1</span>).<span class="built_in">toInt</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//        ui-&gt;simComboBox-&gt;blockSignals(true);</span></span><br><span class="line">        ui-&gt;simComboBox-&gt;<span class="built_in">setCurrentIndex</span>(i);<span class="comment">//选择对应模式，如Xplane</span></span><br><span class="line"><span class="comment">//        ui-&gt;simComboBox-&gt;blockSignals(false);</span></span><br><span class="line">        <span class="built_in">on_simComboBox_currentIndexChanged</span>(i);<span class="comment">//新建仿真连接待用，并调整为Xplane对应的HIL界面</span></span><br><span class="line">    &#125;</span><br><span class="line">    settings.<span class="built_in">endGroup</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="fb19/image-20230413233439378.png" alt="image-20230413233439378" style="zoom:50%;" /></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">QGCHilConfiguration::on_simComboBox_currentIndexChanged</span><span class="params">(<span class="type">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//清除原通用子窗口</span></span><br><span class="line">    QLayoutItem *child;</span><br><span class="line">    <span class="keyword">while</span> ((child = ui-&gt;simulatorConfigurationLayout-&gt;<span class="built_in">takeAt</span>(<span class="number">0</span>)) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> child-&gt;<span class="built_in">widget</span>();</span><br><span class="line">        <span class="keyword">delete</span> child;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">2</span> == index || <span class="number">3</span> == index)<span class="comment">//bf--创建Xplane的子窗口</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Ensure the sim exists and is disabled</span></span><br><span class="line">        _vehicle-&gt;<span class="built_in">uas</span>()-&gt;<span class="built_in">enableHilXPlane</span>(<span class="literal">false</span>);<span class="comment">//创建一个QGCXPlaneLink，并分配线程，但是未开启</span></span><br><span class="line">        QGCHilXPlaneConfiguration* hxpconf = <span class="keyword">new</span> <span class="built_in">QGCHilXPlaneConfiguration</span>(_vehicle-&gt;<span class="built_in">uas</span>()-&gt;<span class="built_in">getHILSimulation</span>(), <span class="keyword">this</span>);<span class="comment">//建立窗口</span></span><br><span class="line">        hxpconf-&gt;<span class="built_in">show</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>建立QGCXPlaneLink</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UAS::enableHilXPlane</span><span class="params">(<span class="type">bool</span> enable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QGCXPlaneLink* link = <span class="built_in">dynamic_cast</span>&lt;QGCXPlaneLink*&gt;(simulation);</span><br><span class="line">    <span class="keyword">if</span> (!link) &#123;</span><br><span class="line">        <span class="keyword">if</span> (simulation) &#123;</span><br><span class="line">            <span class="built_in">stopHil</span>();</span><br><span class="line">            <span class="keyword">delete</span> simulation;</span><br><span class="line">        &#125;</span><br><span class="line">        simulation = <span class="keyword">new</span> <span class="built_in">QGCXPlaneLink</span>(_vehicle);</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> noise_scaler = <span class="number">0.0001f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Connect X-Plane Link</span></span><br><span class="line">    <span class="keyword">if</span> (enable)   &#123; <span class="built_in">startHil</span>(); &#125;</span><br><span class="line">    <span class="keyword">else</span>    &#123; <span class="built_in">stopHil</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QGCXPlaneLink</span> : <span class="keyword">public</span> QGCHilLink<span class="comment">//继承了QGCHilLink的虚类</span></span><br><span class="line">    </span><br><span class="line">QGCXPlaneLink::<span class="built_in">QGCXPlaneLink</span>(Vehicle* vehicle, QString remoteHost, QHostAddress localHost, quint16 localPort) :<span class="comment">//建立Xplane连接的构造函数</span></span><br><span class="line">    _vehicle(vehicle),</span><br><span class="line">    <span class="built_in">remoteHost</span>(<span class="built_in">QHostAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>)),</span><br><span class="line">    <span class="built_in">remotePort</span>(<span class="number">49000</span>),</span><br><span class="line">    <span class="built_in">socket</span>(<span class="literal">NULL</span>),</span><br><span class="line">    <span class="built_in">process</span>(<span class="literal">NULL</span>),</span><br><span class="line">    <span class="built_in">terraSync</span>(<span class="literal">NULL</span>),</span><br><span class="line">    <span class="built_in">barometerOffsetkPa</span>(<span class="number">-8.0f</span>),</span><br><span class="line">    <span class="built_in">airframeID</span>(QGCXPlaneLink::AIRFRAME_UNKNOWN),</span><br><span class="line">    <span class="built_in">xPlaneConnected</span>(<span class="literal">false</span>),</span><br><span class="line">    <span class="built_in">xPlaneVersion</span>(<span class="number">0</span>),</span><br><span class="line">    <span class="built_in">simUpdateLast</span>(QGC::<span class="built_in">groundTimeMilliseconds</span>()),</span><br><span class="line">    <span class="built_in">simUpdateFirst</span>(<span class="number">0</span>),</span><br><span class="line">    <span class="built_in">simUpdateLastText</span>(QGC::<span class="built_in">groundTimeMilliseconds</span>()),</span><br><span class="line">    <span class="built_in">simUpdateLastGroundTruth</span>(QGC::<span class="built_in">groundTimeMilliseconds</span>()),</span><br><span class="line">    <span class="built_in">simUpdateHz</span>(<span class="number">0</span>),</span><br><span class="line">    _sensorHilEnabled(<span class="literal">true</span>),</span><br><span class="line">    _useHilActuatorControls(<span class="literal">true</span>),</span><br><span class="line">    _should_exit(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// We&#x27;re doing it wrong - because the Qt folks got the API wrong:</span></span><br><span class="line">    <span class="comment">// http://blog.qt.digia.com/blog/2010/06/17/youre-doing-it-wrong/</span></span><br><span class="line">    <span class="comment">//官方说这里错了，因为QT的API的错的，还不太理解。</span></span><br><span class="line">    <span class="built_in">moveToThread</span>(<span class="keyword">this</span>);<span class="comment">//给QGCXPlaneLink分配一个线程</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTerminationEnabled</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>-&gt;localHost = localHost;</span><br><span class="line">    <span class="keyword">this</span>-&gt;localPort = localPort<span class="comment">/*+mav-&gt;getUASID()*/</span>;</span><br><span class="line">    connectState = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>-&gt;name = <span class="built_in">tr</span>(<span class="string">&quot;X-Plane Link (localPort:%1)&quot;</span>).<span class="built_in">arg</span>(localPort);</span><br><span class="line">    <span class="built_in">setRemoteHost</span>(remoteHost);</span><br><span class="line">    <span class="built_in">loadSettings</span>();<span class="comment">//加载上次设置的端口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>建立Xplane窗口</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">QGCHilXPlaneConfiguration::<span class="built_in">QGCHilXPlaneConfiguration</span>(QGCHilLink* link, QGCHilConfiguration *parent) :</span><br><span class="line">    <span class="built_in">QWidget</span>(parent),</span><br><span class="line">    <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::QGCHilXPlaneConfiguration)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>-&gt;link = link;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(ui-&gt;startButton, &amp;QPushButton::clicked, <span class="keyword">this</span>, &amp;QGCHilXPlaneConfiguration::toggleSimulation);<span class="comment">//开始仿真的槽函数</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(ui-&gt;hostComboBox, <span class="built_in">static_cast</span>&lt;<span class="built_in">void</span> (QComboBox::*)(<span class="type">const</span> QString&amp;)&gt;(&amp;QComboBox::activated),</span><br><span class="line">            link, &amp;QGCHilLink::setRemoteHost);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(link, &amp;QGCHilLink::remoteChanged, ui-&gt;hostComboBox, &amp;QComboBox::setEditText);</span><br><span class="line">    <span class="built_in">connect</span>(link, &amp;QGCHilLink::statusMessage, parent, &amp;QGCHilConfiguration::receiveStatusMessage);</span><br><span class="line"></span><br><span class="line">    ui-&gt;startButton-&gt;<span class="built_in">setText</span>(<span class="built_in">tr</span>(<span class="string">&quot;Connect&quot;</span>));</span><br><span class="line"></span><br><span class="line">    QGCXPlaneLink* xplane = <span class="built_in">dynamic_cast</span>&lt;QGCXPlaneLink*&gt;(link);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="fb19/image-20230413235137805.png" alt="image-20230413235137805" style="zoom:50%;" /></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">QGCHilXPlaneConfiguration::toggleSimulation</span><span class="params">(<span class="type">bool</span> connect)</span><span class="comment">//line59，开始仿真</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!link) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(connect);</span><br><span class="line">    <span class="keyword">if</span> (!link-&gt;<span class="built_in">isConnected</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        link-&gt;<span class="built_in">setRemoteHost</span>(ui-&gt;hostComboBox-&gt;<span class="built_in">currentText</span>());</span><br><span class="line">        link-&gt;<span class="built_in">connectSimulation</span>();</span><br><span class="line">        </span><br><span class="line">        ui-&gt;startButton-&gt;<span class="built_in">setText</span>(<span class="built_in">tr</span>(<span class="string">&quot;Disconnect&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        link-&gt;<span class="built_in">disconnectSimulation</span>();</span><br><span class="line">        ui-&gt;startButton-&gt;<span class="built_in">setText</span>(<span class="built_in">tr</span>(<span class="string">&quot;Connect&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QGCXPlaneLink::connectSimulation</span><span class="params">()</span><span class="comment">//line1248，开始仿真</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (connectState) &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Simulation already active&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;STARTING X-PLANE LINK, CONNECTING TO&quot;</span> &lt;&lt; remoteHost &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; remotePort;</span><br><span class="line">        <span class="comment">// XXX Hack</span></span><br><span class="line">        <span class="built_in">storeSettings</span>();<span class="comment">//保存设置的端口</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">start</span>(HighPriority);<span class="comment">//开始，启动线程，即前面构造函数使用moveToThread(this)分配的线程</span></span><br><span class="line">        <span class="comment">//当调用start（）之后，启动线程，并把run()中的代码放到线程中运行。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QGCXPlaneLink::run</span><span class="params">()</span><span class="comment">//line163--运行线程</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!_vehicle) &#123;</span><br><span class="line">        <span class="function">emit <span class="title">statusMessage</span><span class="params">(<span class="string">&quot;No MAV present&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connectState) &#123;</span><br><span class="line">        <span class="function">emit <span class="title">statusMessage</span><span class="params">(<span class="string">&quot;Already connected&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    socket = <span class="keyword">new</span> <span class="built_in">QUdpSocket</span>(<span class="keyword">this</span>);<span class="comment">//bf--建立UDP，并运行</span></span><br><span class="line">    socket-&gt;<span class="built_in">moveToThread</span>(<span class="keyword">this</span>);</span><br><span class="line">    connectState = socket-&gt;<span class="built_in">bind</span>(localHost, localPort, QAbstractSocket::ReuseAddressHint);</span><br><span class="line">    <span class="keyword">if</span> (!connectState) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function">emit <span class="title">statusMessage</span><span class="params">(<span class="string">&quot;Binding socket failed!&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">        socket-&gt;<span class="built_in">deleteLater</span>();</span><br><span class="line">        socket = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">emit <span class="title">statusMessage</span><span class="params">(tr(<span class="string">&quot;Waiting for XPlane..&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    QObject::<span class="built_in">connect</span>(socket, &amp;QUdpSocket::readyRead, <span class="keyword">this</span>, &amp;QGCXPlaneLink::readBytes);<span class="comment">//bf--UDP有新数据时，执行readBytes</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(_vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::hilControlsChanged, <span class="keyword">this</span>, &amp;QGCXPlaneLink::updateControls, Qt::QueuedConnection);<span class="comment">//bf--不选择执行器时的舵</span></span><br><span class="line">    <span class="built_in">connect</span>(_vehicle, &amp;Vehicle::hilActuatorControlsChanged, <span class="keyword">this</span>, &amp;QGCXPlaneLink::updateActuatorControls, Qt::QueuedConnection);<span class="comment">//bf--选择执行器时的舵</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::hilGroundTruthChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilGroundTruth, Qt::QueuedConnection);</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::hilStateChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilState, Qt::QueuedConnection);</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::sensorHilGpsChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilGps, Qt::QueuedConnection);</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::sensorHilRawImuChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilSensors, Qt::QueuedConnection);</span><br><span class="line"></span><br><span class="line">    _vehicle-&gt;<span class="built_in">uas</span>()-&gt;<span class="built_in">startHil</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面这段，应该是在主机上找到所有IP地址，并对本地回环发包测试</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(push, 1)</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">iset_struct</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> b[<span class="number">5</span>];</span><br><span class="line">        <span class="type">int</span> index; <span class="comment">// (0-&gt;20 in the list below)</span></span><br><span class="line">        <span class="type">char</span> str_ipad_them[<span class="number">16</span>];</span><br><span class="line">        <span class="type">char</span> str_port_them[<span class="number">6</span>];</span><br><span class="line">        <span class="type">char</span> padding[<span class="number">2</span>];</span><br><span class="line">        <span class="type">int</span> use_ip;</span><br><span class="line">    &#125; ip; <span class="comment">// to use this option, 0 not to.</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(pop)</span></span><br><span class="line"></span><br><span class="line">    ip.b[<span class="number">0</span>] = <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">    ip.b[<span class="number">1</span>] = <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line">    ip.b[<span class="number">2</span>] = <span class="string">&#x27;E&#x27;</span>;</span><br><span class="line">    ip.b[<span class="number">3</span>] = <span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">    ip.b[<span class="number">4</span>] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    QList&lt;QHostAddress&gt; hostAddresses = QNetworkInterface::<span class="built_in">allAddresses</span>();</span><br><span class="line"></span><br><span class="line">    QString localAddrStr;</span><br><span class="line">    QString localPortStr = <span class="built_in">QString</span>(<span class="string">&quot;%1&quot;</span>).<span class="built_in">arg</span>(localPort);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; hostAddresses.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Exclude loopback IPv4 and all IPv6 addresses</span></span><br><span class="line">        <span class="keyword">if</span> (hostAddresses.<span class="built_in">at</span>(i) != <span class="built_in">QHostAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>) &amp;&amp; !hostAddresses.<span class="built_in">at</span>(i).<span class="built_in">toString</span>().<span class="built_in">contains</span>(<span class="string">&quot;:&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            localAddrStr = hostAddresses.<span class="built_in">at</span>(i).<span class="built_in">toString</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ip.index = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strncpy</span>(ip.str_ipad_them, localAddrStr.<span class="built_in">toLatin1</span>(), <span class="built_in">qMin</span>((<span class="type">int</span>)<span class="built_in">sizeof</span>(ip.str_ipad_them), <span class="number">16</span>));</span><br><span class="line">    <span class="built_in">strncpy</span>(ip.str_port_them, localPortStr.<span class="built_in">toLatin1</span>(), <span class="built_in">qMin</span>((<span class="type">int</span>)<span class="built_in">sizeof</span>(ip.str_port_them), <span class="number">6</span>));</span><br><span class="line">    ip.use_ip = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">writeBytesSafe</span>((<span class="type">const</span> <span class="type">char</span>*)&amp;ip, <span class="built_in">sizeof</span>(ip));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Call function which makes sure individual control override is enabled/disabled */</span></span><br><span class="line">    <span class="built_in">enableHilActuatorControls</span>(_useHilActuatorControls);</span><br><span class="line"></span><br><span class="line">    _should_exit = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!_should_exit) &#123;<span class="comment">//bf--在退出之前，一直阻塞执行</span></span><br><span class="line">        QCoreApplication::<span class="built_in">processEvents</span>();</span><br><span class="line">        QGC::SLEEP::<span class="built_in">msleep</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//退出</span></span><br><span class="line">    <span class="built_in">disconnect</span>(_vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::hilControlsChanged, <span class="keyword">this</span>, &amp;QGCXPlaneLink::updateControls);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">disconnect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::hilGroundTruthChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilGroundTruth);</span><br><span class="line">    <span class="built_in">disconnect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::hilStateChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilState);</span><br><span class="line">    <span class="built_in">disconnect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::sensorHilGpsChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilGps);</span><br><span class="line">    <span class="built_in">disconnect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::sensorHilRawImuChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilSensors);</span><br><span class="line">    connectState = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">disconnect</span>(socket, &amp;QUdpSocket::readyRead, <span class="keyword">this</span>, &amp;QGCXPlaneLink::readBytes);</span><br><span class="line"></span><br><span class="line">    socket-&gt;<span class="built_in">close</span>();</span><br><span class="line">    socket-&gt;<span class="built_in">deleteLater</span>();</span><br><span class="line">    socket = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">emit <span class="title">simulationDisconnected</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">emit <span class="title">simulationConnected</span><span class="params">(<span class="literal">false</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UAS::startHil</span><span class="params">()</span><span class="comment">//line1492，开始HIL</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hilEnabled) <span class="keyword">return</span>;</span><br><span class="line">    hilEnabled = <span class="literal">true</span>;</span><br><span class="line">    sensorHil = <span class="literal">false</span>;</span><br><span class="line">    _vehicle-&gt;<span class="built_in">setHilMode</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; __FILE__ &lt;&lt; __LINE__ &lt;&lt; <span class="string">&quot;HIL is onboard not enabled, trying to enable.&quot;</span>;</span><br><span class="line">    <span class="comment">// Connect HIL simulation link</span></span><br><span class="line">    simulation-&gt;<span class="built_in">connectSimulation</span>();<span class="comment">//开始仿真</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Vehicle::setHilMode</span><span class="params">(<span class="type">bool</span> hilMode)</span><span class="comment">//line2447，MAVLINK发送开始仿真的包</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">mavlink_message_t</span> msg;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> newBaseMode = _base_mode &amp; ~MAV_MODE_FLAG_DECODE_POSITION_HIL;</span><br><span class="line">    <span class="keyword">if</span> (hilMode) &#123;</span><br><span class="line">        newBaseMode |= MAV_MODE_FLAG_HIL_ENABLED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mavlink_msg_set_mode_pack_chan</span>(_mavlink-&gt;<span class="built_in">getSystemId</span>(),</span><br><span class="line">                                   _mavlink-&gt;<span class="built_in">getComponentId</span>(),</span><br><span class="line">                                   <span class="built_in">priorityLink</span>()-&gt;<span class="built_in">mavlinkChannel</span>(),</span><br><span class="line">                                   &amp;msg,</span><br><span class="line">                                   <span class="built_in">id</span>(),</span><br><span class="line">                                   newBaseMode,</span><br><span class="line">                                   _custom_mode);</span><br><span class="line">    <span class="built_in">sendMessageOnLink</span>(<span class="built_in">priorityLink</span>(), msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">QGCXPlaneLink::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">QObject::connect</span><span class="params">(socket, &amp;QUdpSocket::readyRead, <span class="keyword">this</span>, &amp;QGCXPlaneLink::readBytes)</span></span>;<span class="comment">//bf--UDP有新数据时，执行readBytes</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">connect</span>(_vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::hilControlsChanged, <span class="keyword">this</span>, &amp;QGCXPlaneLink::updateControls, Qt::QueuedConnection);<span class="comment">//bf--不选择执行器时的舵</span></span><br><span class="line"><span class="built_in">connect</span>(_vehicle, &amp;Vehicle::hilActuatorControlsChanged, <span class="keyword">this</span>, &amp;QGCXPlaneLink::updateActuatorControls, Qt::QueuedConnection);<span class="comment">//bf--选择执行器时的舵</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::hilGroundTruthChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilGroundTruth, Qt::QueuedConnection);<span class="comment">//mavlink发送到PX4中</span></span><br><span class="line"><span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::hilStateChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilState, Qt::QueuedConnection);</span><br><span class="line"><span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::sensorHilGpsChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilGps, Qt::QueuedConnection);</span><br><span class="line"><span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QGCXPlaneLink::sensorHilRawImuChanged, _vehicle-&gt;<span class="built_in">uas</span>(), &amp;UAS::sendHilSensors, Qt::QueuedConnection);</span><br></pre></td></tr></table></figure>
<h4 id="接收UDP"><a href="#接收UDP" class="headerlink" title="接收UDP"></a>接收UDP</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">QGCXPlaneLink::readBytes</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Only emit updates on attitude message</span></span><br><span class="line">    <span class="type">bool</span> emitUpdate = <span class="literal">false</span>;</span><br><span class="line">    quint16 fields_changed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> qint64 maxLength = <span class="number">65536</span>;</span><br><span class="line">    <span class="type">char</span> data[maxLength];</span><br><span class="line">    QHostAddress sender;</span><br><span class="line">    quint16 senderPort;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> s = socket-&gt;<span class="built_in">pendingDatagramSize</span>();</span><br><span class="line">    <span class="keyword">if</span> (s &gt; maxLength) std::cerr &lt;&lt; __FILE__ &lt;&lt; __LINE__ &lt;&lt; <span class="string">&quot; UDP datagram overflow, allowed to read less bytes than datagram size: &quot;</span> &lt;&lt; s &lt;&lt; std::endl;</span><br><span class="line">    socket-&gt;<span class="built_in">readDatagram</span>(data, maxLength, &amp;sender, &amp;senderPort);</span><br><span class="line">    <span class="keyword">if</span> (s &gt; maxLength) &#123;</span><br><span class="line">    	std::string headStr = std::<span class="built_in">string</span>(data, data+<span class="number">5</span>);</span><br><span class="line">    	std::cerr &lt;&lt; __FILE__ &lt;&lt; __LINE__ &lt;&lt; <span class="string">&quot; UDP datagram header: &quot;</span> &lt;&lt; headStr &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Calculate the number of data segments a 36 bytes</span></span><br><span class="line">    <span class="comment">// XPlane always has 5 bytes header: &#x27;DATA@&#x27;</span></span><br><span class="line">    <span class="type">unsigned</span> nsegs = (s<span class="number">-5</span>)/<span class="number">36</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//qDebug() &lt;&lt; &quot;XPLANE:&quot; &lt;&lt; &quot;LEN:&quot; &lt;&lt; s &lt;&lt; &quot;segs:&quot; &lt;&lt; nsegs;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> pack(push, 1)</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">payload</span> &#123;</span><br><span class="line">        <span class="type">int</span> index;</span><br><span class="line">        <span class="comment">//float f[8];</span></span><br><span class="line">        <span class="type">float</span> f[<span class="number">22</span>];<span class="comment">//bfaner--xplane data size</span></span><br><span class="line">    &#125; p;</span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> pack(pop)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> oldConnectionState = xPlaneConnected;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data[<span class="number">0</span>] == <span class="string">&#x27;D&#x27;</span> &amp;&amp;</span><br><span class="line">            data[<span class="number">1</span>] == <span class="string">&#x27;A&#x27;</span> &amp;&amp;</span><br><span class="line">            data[<span class="number">2</span>] == <span class="string">&#x27;T&#x27;</span> &amp;&amp;</span><br><span class="line">            data[<span class="number">3</span>] == <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        xPlaneConnected = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oldConnectionState != xPlaneConnected) &#123;</span><br><span class="line">            simUpdateFirst = QGC::<span class="built_in">groundTimeMilliseconds</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; nsegs; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Get index</span></span><br><span class="line">            <span class="type">unsigned</span> ioff = (<span class="number">5</span>+i*<span class="number">36</span>);;</span><br><span class="line">            <span class="built_in">memcpy</span>(&amp;(p), data+ioff, <span class="built_in">sizeof</span>(p));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//bfaner--xplane receive all data</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(xPlaneVersion == <span class="number">10</span> &amp;&amp; p.index == <span class="number">9</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//角速度--deg/s【p、q、r】【012】</span></span><br><span class="line">                rollspeed = p.f[<span class="number">0</span>] / <span class="number">180.0f</span> * M_PI;</span><br><span class="line">                pitchspeed = p.f[<span class="number">1</span>] / <span class="number">180.0f</span> * M_PI;</span><br><span class="line">                yawspeed = p.f[<span class="number">2</span>] / <span class="number">180.0f</span> * M_PI;</span><br><span class="line">                fields_changed |= (<span class="number">1</span> &lt;&lt; <span class="number">3</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">4</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">5</span>);</span><br><span class="line">                <span class="comment">//emitUpdate = true;//bfaner--注释</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//角度--deg【roll、pitch、yaw、mag】【3456】</span></span><br><span class="line">                <span class="comment">//qDebug() &lt;&lt; &quot;HDNG&quot; &lt;&lt; &quot;pitch&quot; &lt;&lt; p.f[0] &lt;&lt; &quot;roll&quot; &lt;&lt; p.f[1] &lt;&lt; &quot;hding true&quot; &lt;&lt; p.f[2] &lt;&lt; &quot;hding mag&quot; &lt;&lt; p.f[3];</span></span><br><span class="line">                roll = p.f[<span class="number">3</span>] / <span class="number">180.0f</span> * M_PI;</span><br><span class="line">                pitch = p.f[<span class="number">4</span>] / <span class="number">180.0f</span> * M_PI;</span><br><span class="line">                yaw = p.f[<span class="number">5</span>] / <span class="number">180.0f</span> * M_PI;</span><br><span class="line">                <span class="type">float</span> yawmag = p.f[<span class="number">6</span>] / <span class="number">180.0f</span> * M_PI;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// X-Plane expresses yaw as 0..2 PI</span></span><br><span class="line">                <span class="keyword">if</span> (yaw &gt; M_PI) &#123;</span><br><span class="line">                    yaw -= <span class="number">2.0f</span> * <span class="built_in">static_cast</span>&lt;<span class="type">float</span>&gt;(M_PI);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (yaw &lt; -M_PI) &#123;</span><br><span class="line">                    yaw += <span class="number">2.0f</span> * <span class="built_in">static_cast</span>&lt;<span class="type">float</span>&gt;(M_PI);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (yawmag &gt; M_PI) &#123;</span><br><span class="line">                    yawmag -= <span class="number">2.0f</span> * <span class="built_in">static_cast</span>&lt;<span class="type">float</span>&gt;(M_PI);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (yawmag &lt; -M_PI) &#123;</span><br><span class="line">                    yawmag += <span class="number">2.0f</span> * <span class="built_in">static_cast</span>&lt;<span class="type">float</span>&gt;(M_PI);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Normal rotation matrix, but since we rotate the</span></span><br><span class="line">                <span class="comment">// vector [0.25 0 0.45]&#x27;, we end up with these relevant</span></span><br><span class="line">                <span class="comment">// matrix parts.</span></span><br><span class="line"></span><br><span class="line">                xmag = <span class="built_in">cos</span>(-yawmag) * <span class="number">0.25f</span>;</span><br><span class="line">                ymag = <span class="built_in">sin</span>(-yawmag) * <span class="number">0.25f</span>;</span><br><span class="line">                zmag = <span class="number">0.45f</span>;</span><br><span class="line">                fields_changed |= (<span class="number">1</span> &lt;&lt; <span class="number">6</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">7</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">double</span> cosPhi = <span class="built_in">cos</span>(roll);</span><br><span class="line">                <span class="type">double</span> sinPhi = <span class="built_in">sin</span>(roll);</span><br><span class="line">                <span class="type">double</span> cosThe = <span class="built_in">cos</span>(pitch);</span><br><span class="line">                <span class="type">double</span> sinThe = <span class="built_in">sin</span>(pitch);</span><br><span class="line">                <span class="type">double</span> cosPsi = <span class="built_in">cos</span>(<span class="number">0.0</span>);</span><br><span class="line">                <span class="type">double</span> sinPsi = <span class="built_in">sin</span>(<span class="number">0.0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">float</span> dcm[<span class="number">3</span>][<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">                dcm[<span class="number">0</span>][<span class="number">0</span>] = cosThe * cosPsi;</span><br><span class="line">                dcm[<span class="number">0</span>][<span class="number">1</span>] = -cosPhi * sinPsi + sinPhi * sinThe * cosPsi;</span><br><span class="line">                dcm[<span class="number">0</span>][<span class="number">2</span>] = sinPhi * sinPsi + cosPhi * sinThe * cosPsi;</span><br><span class="line"></span><br><span class="line">                dcm[<span class="number">1</span>][<span class="number">0</span>] = cosThe * sinPsi;</span><br><span class="line">                dcm[<span class="number">1</span>][<span class="number">1</span>] = cosPhi * cosPsi + sinPhi * sinThe * sinPsi;</span><br><span class="line">                dcm[<span class="number">1</span>][<span class="number">2</span>] = -sinPhi * cosPsi + cosPhi * sinThe * sinPsi;</span><br><span class="line"></span><br><span class="line">                dcm[<span class="number">2</span>][<span class="number">0</span>] = -sinThe;</span><br><span class="line">                dcm[<span class="number">2</span>][<span class="number">1</span>] = sinPhi * cosThe;</span><br><span class="line">                dcm[<span class="number">2</span>][<span class="number">2</span>] = cosPhi * cosThe;</span><br><span class="line"></span><br><span class="line">                Eigen::Matrix3f m = Eigen::<span class="built_in">Map</span>&lt;Eigen::Matrix3f&gt;((<span class="type">float</span>*)dcm).<span class="built_in">eval</span>();</span><br><span class="line"></span><br><span class="line">                <span class="function">Eigen::Vector3f <span class="title">mag</span><span class="params">(xmag, ymag, zmag)</span></span>;</span><br><span class="line"></span><br><span class="line">                Eigen::Vector3f magbody = m * mag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//                qDebug() &lt;&lt; &quot;yaw mag:&quot; &lt;&lt; p.f[2] &lt;&lt; &quot;x&quot; &lt;&lt; xmag &lt;&lt; &quot;y&quot; &lt;&lt; ymag;</span></span><br><span class="line">    <span class="comment">//                qDebug() &lt;&lt; &quot;yaw mag in body:&quot; &lt;&lt; magbody(0) &lt;&lt; magbody(1) &lt;&lt; magbody(2);</span></span><br><span class="line"></span><br><span class="line">                xmag = <span class="built_in">magbody</span>(<span class="number">0</span>);</span><br><span class="line">                ymag = <span class="built_in">magbody</span>(<span class="number">1</span>);</span><br><span class="line">                zmag = <span class="built_in">magbody</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Rotate the measurement vector into the body frame using roll and pitch</span></span><br><span class="line">                <span class="comment">//emitUpdate = true;//emitUpdate = true;//bfaner--注释</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//加速度--g--【789】</span></span><br><span class="line">                <span class="comment">// WORKAROUND: IF ground speed &lt;&lt;1m/s and altitude-above-ground &lt;1m, do NOT use the X-Plane data, because X-Plane (tested</span></span><br><span class="line">                <span class="comment">// with v10.3 and earlier) delivers yacc=0 and zacc=0 when the ground speed is very low, which gives e.g. wrong readings</span></span><br><span class="line">                <span class="comment">// before launch when waiting on the runway. This might pose a problem for initial state estimation/calibration.</span></span><br><span class="line">                <span class="comment">// Instead, we calculate our own accelerations.</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">fabsf</span>(groundspeed)&lt;<span class="number">0.1f</span> &amp;&amp; alt_agl&lt;<span class="number">1.0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Add centrip. acceleration to the current static acceleration implementation.</span></span><br><span class="line">                    <span class="function">Eigen::Vector3f <span class="title">g</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-9.80665f</span>)</span></span>;</span><br><span class="line">                    Eigen::Matrix3f R = <span class="built_in">euler_to_wRo</span>(yaw, pitch, roll);</span><br><span class="line">                    Eigen::Vector3f gr = R.<span class="built_in">transpose</span>().<span class="built_in">eval</span>() * g;</span><br><span class="line"></span><br><span class="line">                    xacc = gr[<span class="number">0</span>];</span><br><span class="line">                    yacc = gr[<span class="number">1</span>];</span><br><span class="line">                    zacc = gr[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//qDebug() &lt;&lt; &quot;Calculated values&quot; &lt;&lt; gr[0] &lt;&lt; gr[1] &lt;&lt; gr[2];</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Accelerometer readings, directly from X-Plane and including centripetal forces.</span></span><br><span class="line">                    <span class="type">const</span> <span class="type">float</span> one_g = <span class="number">9.80665f</span>;</span><br><span class="line">                    xacc = p.f[<span class="number">7</span>] * one_g;</span><br><span class="line">                    yacc = p.f[<span class="number">8</span>] * one_g;</span><br><span class="line">                    zacc = p.f[<span class="number">9</span>] * one_g;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//qDebug() &lt;&lt; &quot;X-Plane values&quot; &lt;&lt; xacc &lt;&lt; yacc &lt;&lt; zacc;</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                fields_changed |= (<span class="number">1</span> &lt;&lt; <span class="number">0</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">1</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line">                <span class="comment">//emitUpdate = true;//bfaner--注释</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//速度--m/s【vx、vy、vz、IAS、TAS、GS】【10、11、12、13、14、15】</span></span><br><span class="line">                vx = p.f[<span class="number">10</span>];</span><br><span class="line">                vy = p.f[<span class="number">11</span>];</span><br><span class="line">                vz = p.f[<span class="number">12</span>];</span><br><span class="line">                ind_airspeed = p.f[<span class="number">13</span>];</span><br><span class="line">                true_airspeed = p.f[<span class="number">14</span>];</span><br><span class="line">                groundspeed = p.f[<span class="number">15</span>];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//位置--度度米【lat、lon、alt、alt_agl】【16、17、18、19】</span></span><br><span class="line">                <span class="comment">//qDebug() &lt;&lt; &quot;LAT/LON/ALT:&quot; &lt;&lt; p.f[0] &lt;&lt; p.f[1] &lt;&lt; p.f[2];</span></span><br><span class="line">                lat = p.f[<span class="number">16</span>];</span><br><span class="line">                lon = p.f[<span class="number">17</span>];</span><br><span class="line">                alt = p.f[<span class="number">18</span>];</span><br><span class="line">                alt_agl = p.f[<span class="number">19</span>];</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 气压、温度--hPa、degC--百帕、摄氏度【20、21】</span></span><br><span class="line">                abs_pressure = p.f[<span class="number">20</span>] * <span class="number">0.01f</span>;</span><br><span class="line">                temperature = p.f[<span class="number">21</span>] - <span class="number">273.15f</span>;</span><br><span class="line">                fields_changed |= (<span class="number">1</span> &lt;&lt; <span class="number">9</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">                emitUpdate = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//qDebug() &lt;&lt; &quot;UNKNOWN #&quot; &lt;&lt; p.index &lt;&lt; p.f[0] &lt;&lt; p.f[1] &lt;&lt; p.f[2] &lt;&lt; p.f[3];</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wait for 0.5s before actually using the data, so that all fields are filled</span></span><br><span class="line">    <span class="comment">// 因为上边全部使用一个包发送，所以不需要等待所有包，下面可以注释掉，以提升实时性。</span></span><br><span class="line">    <span class="keyword">if</span> (QGC::<span class="built_in">groundTimeMilliseconds</span>() - simUpdateFirst &lt; <span class="number">500</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send updated state</span></span><br><span class="line">    <span class="comment">//bfaner change 500Hz to 200Hz</span></span><br><span class="line">    <span class="keyword">if</span> (emitUpdate &amp;&amp; (QGC::<span class="built_in">groundTimeMilliseconds</span>() - simUpdateLast) &gt; <span class="number">5</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        simUpdateHz = simUpdateHz * <span class="number">0.9f</span> + <span class="number">0.1f</span> * (<span class="number">1000.0f</span> / (QGC::<span class="built_in">groundTimeMilliseconds</span>() - simUpdateLast));</span><br><span class="line">        <span class="keyword">if</span> (QGC::<span class="built_in">groundTimeMilliseconds</span>() - simUpdateLastText &gt; <span class="number">2000</span>) &#123;</span><br><span class="line">            <span class="function">emit <span class="title">statusMessage</span><span class="params">(tr(<span class="string">&quot;Receiving from XPlane at %1 Hz&quot;</span>).arg(<span class="keyword">static_cast</span>&lt;<span class="type">int</span>&gt;(simUpdateHz)))</span></span>;</span><br><span class="line">            <span class="comment">// Reset lowpass with current value</span></span><br><span class="line">            simUpdateHz = (<span class="number">1000.0f</span> / (QGC::<span class="built_in">groundTimeMilliseconds</span>() - simUpdateLast));</span><br><span class="line">            <span class="comment">// Set state</span></span><br><span class="line">            simUpdateLastText = QGC::<span class="built_in">groundTimeMilliseconds</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        simUpdateLast = QGC::<span class="built_in">groundTimeMilliseconds</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_sensorHilEnabled)</span><br><span class="line">        &#123;</span><br><span class="line">            diff_pressure = (ind_airspeed * ind_airspeed * <span class="number">1.225f</span>) / <span class="number">2.0f</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* tropospheric properties (0-11km) for standard atmosphere */</span></span><br><span class="line">            <span class="type">const</span> <span class="type">double</span> T1 = <span class="number">15.0</span> + <span class="number">273.15</span>;	<span class="comment">/* temperature at base height in Kelvin */</span></span><br><span class="line">            <span class="type">const</span> <span class="type">double</span> a  = <span class="number">-6.5</span> / <span class="number">1000</span>;	<span class="comment">/* temperature gradient in degrees per metre */</span></span><br><span class="line">            <span class="type">const</span> <span class="type">double</span> g  = <span class="number">9.80665</span>;	<span class="comment">/* gravity constant in m/s/s */</span></span><br><span class="line">            <span class="type">const</span> <span class="type">double</span> R  = <span class="number">287.05</span>;	<span class="comment">/* ideal gas constant in J/kg/K */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* current pressure at MSL in kPa */</span></span><br><span class="line">            <span class="type">double</span> p1 = <span class="number">1013.25</span> / <span class="number">10.0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* measured pressure in hPa, plus offset to simulate weather effects / offsets */</span></span><br><span class="line">            <span class="type">double</span> p = abs_pressure / <span class="number">10.0</span> + barometerOffsetkPa;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Solve:</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             *     /        -(aR / g)     \</span></span><br><span class="line"><span class="comment">             *    | (p / p1)          . T1 | - T1</span></span><br><span class="line"><span class="comment">             *     \                      /</span></span><br><span class="line"><span class="comment">             * h = -------------------------------  + h1</span></span><br><span class="line"><span class="comment">             *                   a</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            pressure_alt = (((<span class="built_in">pow</span>((p / p1), (-(a * R) / g))) * T1) - T1) / a;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// set pressure alt to changed</span></span><br><span class="line">            fields_changed |= (<span class="number">1</span> &lt;&lt; <span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">            <span class="function">emit <span class="title">sensorHilRawImuChanged</span><span class="params">(QGC::groundTimeUsecs(), xacc, yacc, zacc, rollspeed, pitchspeed, yawspeed,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        xmag, ymag, zmag, abs_pressure, diff_pressure / <span class="number">100.0</span>, pressure_alt, temperature, fields_changed)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// XXX make these GUI-configurable and add randomness</span></span><br><span class="line">            <span class="type">int</span> gps_fix_type = <span class="number">3</span>;</span><br><span class="line">            <span class="type">float</span> eph = <span class="number">0.3f</span>;</span><br><span class="line">            <span class="type">float</span> epv = <span class="number">0.6f</span>;</span><br><span class="line">            <span class="type">float</span> vel = <span class="built_in">sqrt</span>(vx*vx + vy*vy + vz*vz);</span><br><span class="line">            <span class="type">float</span> cog = <span class="built_in">atan2</span>(vy, vx);</span><br><span class="line">            <span class="type">int</span> satellites = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">emit <span class="title">sensorHilGpsChanged</span><span class="params">(QGC::groundTimeUsecs(), lat, lon, alt, gps_fix_type, eph, epv, vel, vx, vy, vz, cog, satellites)</span></span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            emit <span class="built_in">hilStateChanged</span>(QGC::<span class="built_in">groundTimeUsecs</span>(), roll, pitch, yaw, rollspeed,</span><br><span class="line">                                 pitchspeed, yawspeed, lat, lon, alt,</span><br><span class="line">                                 vx, vy, vz, ind_airspeed, true_airspeed, xacc, yacc, zacc);<span class="comment">//不使用滤波器</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Limit ground truth to 25 Hz</span></span><br><span class="line">        <span class="comment">//bfaner test--经过测试，注释hilGroundTruthChanged不影响半物理仿真【可能滤波影响？】</span></span><br><span class="line">        <span class="keyword">if</span> (QGC::<span class="built_in">groundTimeMilliseconds</span>() - simUpdateLastGroundTruth &gt; <span class="number">40</span>) &#123;</span><br><span class="line">            <span class="function">emit <span class="title">hilGroundTruthChanged</span><span class="params">(QGC::groundTimeUsecs(), roll, pitch, yaw, rollspeed,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       pitchspeed, yawspeed, lat, lon, alt,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       vx, vy, vz, ind_airspeed, true_airspeed, xacc, yacc, zacc)</span></span>;</span><br><span class="line"></span><br><span class="line">            simUpdateLastGroundTruth = QGC::<span class="built_in">groundTimeMilliseconds</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!oldConnectionState &amp;&amp; xPlaneConnected)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">emit <span class="title">statusMessage</span><span class="params">(tr(<span class="string">&quot;Receiving from XPlane.&quot;</span>))</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    // Echo data for debugging purposes</span></span><br><span class="line">    <span class="comment">//    std::cerr &lt;&lt; __FILE__ &lt;&lt; __LINE__ &lt;&lt; &quot;Received datagram:&quot; &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">//    int i;</span></span><br><span class="line">    <span class="comment">//    for (i=0; i&lt;s; i++)</span></span><br><span class="line">    <span class="comment">//    &#123;</span></span><br><span class="line">    <span class="comment">//        unsigned int v=data[i];</span></span><br><span class="line">    <span class="comment">//        fprintf(stderr,&quot;%02x &quot;, v);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//    std::cerr &lt;&lt; std::endl;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="发送mavlink"><a href="#发送mavlink" class="headerlink" title="发送mavlink"></a>发送mavlink</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不使用滤波器的发送</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UAS::sendHilState</span><span class="params">(quint64 time_us, <span class="type">float</span> roll, <span class="type">float</span> pitch, <span class="type">float</span> yaw, <span class="type">float</span> rollspeed,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">float</span> pitchspeed, <span class="type">float</span> yawspeed, <span class="type">double</span> lat, <span class="type">double</span> lon, <span class="type">double</span> alt,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">float</span> vx, <span class="type">float</span> vy, <span class="type">float</span> vz, <span class="type">float</span> ind_airspeed, <span class="type">float</span> true_airspeed, <span class="type">float</span> xacc, <span class="type">float</span> yacc, <span class="type">float</span> zacc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!_vehicle) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_vehicle-&gt;<span class="built_in">hilMode</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">float</span> q[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> cosPhi_2 = <span class="built_in">cos</span>(<span class="built_in">double</span>(roll) / <span class="number">2.0</span>);</span><br><span class="line">        <span class="type">double</span> sinPhi_2 = <span class="built_in">sin</span>(<span class="built_in">double</span>(roll) / <span class="number">2.0</span>);</span><br><span class="line">        <span class="type">double</span> cosTheta_2 = <span class="built_in">cos</span>(<span class="built_in">double</span>(pitch) / <span class="number">2.0</span>);</span><br><span class="line">        <span class="type">double</span> sinTheta_2 = <span class="built_in">sin</span>(<span class="built_in">double</span>(pitch) / <span class="number">2.0</span>);</span><br><span class="line">        <span class="type">double</span> cosPsi_2 = <span class="built_in">cos</span>(<span class="built_in">double</span>(yaw) / <span class="number">2.0</span>);</span><br><span class="line">        <span class="type">double</span> sinPsi_2 = <span class="built_in">sin</span>(<span class="built_in">double</span>(yaw) / <span class="number">2.0</span>);</span><br><span class="line">        q[<span class="number">0</span>] = (cosPhi_2 * cosTheta_2 * cosPsi_2 +</span><br><span class="line">                sinPhi_2 * sinTheta_2 * sinPsi_2);</span><br><span class="line">        q[<span class="number">1</span>] = (sinPhi_2 * cosTheta_2 * cosPsi_2 -</span><br><span class="line">                cosPhi_2 * sinTheta_2 * sinPsi_2);</span><br><span class="line">        q[<span class="number">2</span>] = (cosPhi_2 * sinTheta_2 * cosPsi_2 +</span><br><span class="line">                sinPhi_2 * cosTheta_2 * sinPsi_2);</span><br><span class="line">        q[<span class="number">3</span>] = (cosPhi_2 * cosTheta_2 * sinPsi_2 -</span><br><span class="line">                sinPhi_2 * sinTheta_2 * cosPsi_2);</span><br><span class="line"></span><br><span class="line">        <span class="type">mavlink_message_t</span> msg;</span><br><span class="line">        <span class="built_in">mavlink_msg_hil_state_quaternion_pack_chan</span>(mavlink-&gt;<span class="built_in">getSystemId</span>(),</span><br><span class="line">                                                   mavlink-&gt;<span class="built_in">getComponentId</span>(),</span><br><span class="line">                                                   _vehicle-&gt;<span class="built_in">priorityLink</span>()-&gt;<span class="built_in">mavlinkChannel</span>(),</span><br><span class="line">                                                   &amp;msg,</span><br><span class="line">                                                   time_us, q, rollspeed, pitchspeed, yawspeed,</span><br><span class="line">                                                   lat*<span class="number">1e7</span>f, lon*<span class="number">1e7</span>f, alt*<span class="number">1000</span>, vx*<span class="number">100</span>, vy*<span class="number">100</span>, vz*<span class="number">100</span>, ind_airspeed*<span class="number">100</span>, true_airspeed*<span class="number">100</span>, xacc*<span class="number">1000</span>/<span class="number">9.81</span>, yacc*<span class="number">1000</span>/<span class="number">9.81</span>, zacc*<span class="number">1000</span>/<span class="number">9.81</span>);</span><br><span class="line">        _vehicle-&gt;<span class="built_in">sendMessageOnLink</span>(_vehicle-&gt;<span class="built_in">priorityLink</span>(), msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Attempt to set HIL mode</span></span><br><span class="line">        _vehicle-&gt;<span class="built_in">setHilMode</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; __FILE__ &lt;&lt; __LINE__ &lt;&lt; <span class="string">&quot;HIL is onboard not enabled, trying to enable.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="接收mavlink"><a href="#接收mavlink" class="headerlink" title="接收mavlink"></a>接收mavlink</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> Vehicle::_handleHilActuatorControls(<span class="type">mavlink_message_t</span> &amp;message)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">mavlink_hil_actuator_controls_t</span> hil;</span><br><span class="line">    <span class="built_in">mavlink_msg_hil_actuator_controls_decode</span>(&amp;message, &amp;hil);</span><br><span class="line">    <span class="function">emit <span class="title">hilActuatorControlsChanged</span><span class="params">(hil.time_usec, hil.flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    hil.controls[<span class="number">0</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">1</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">2</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">3</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">4</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">5</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">6</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">7</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">8</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">9</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">10</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">11</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">12</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">13</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">14</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.controls[<span class="number">15</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            hil.mode)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="发送UDP"><a href="#发送UDP" class="headerlink" title="发送UDP"></a>发送UDP</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">QGCXPlaneLink::updateActuatorControls</span><span class="params">(quint64 time, quint64 flags, <span class="type">float</span> ctl_0, <span class="type">float</span> ctl_1, <span class="type">float</span> ctl_2, <span class="type">float</span> ctl_3, <span class="type">float</span> ctl_4, <span class="type">float</span> ctl_5, <span class="type">float</span> ctl_6, <span class="type">float</span> ctl_7, <span class="type">float</span> ctl_8, <span class="type">float</span> ctl_9, <span class="type">float</span> ctl_10, <span class="type">float</span> ctl_11, <span class="type">float</span> ctl_12, <span class="type">float</span> ctl_13, <span class="type">float</span> ctl_14, <span class="type">float</span> ctl_15, quint8 mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!_useHilActuatorControls) &#123;</span><br><span class="line">        <span class="comment">//qDebug() &lt;&lt; &quot;received HIL_ACTUATOR_CONTROLS but not using it&quot;;</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> pack(push, 1)</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">payload</span> &#123;</span><br><span class="line">        <span class="type">char</span> b[<span class="number">5</span>];</span><br><span class="line">        <span class="type">int</span> index;</span><br><span class="line">        <span class="type">float</span> f[<span class="number">8</span>];<span class="comment">//考虑也可以通过一个包，全发完</span></span><br><span class="line">    &#125; p;</span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> pack(pop)</span></span><br><span class="line"></span><br><span class="line">    p.b[<span class="number">0</span>] = <span class="string">&#x27;D&#x27;</span>;</span><br><span class="line">    p.b[<span class="number">1</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    p.b[<span class="number">2</span>] = <span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">    p.b[<span class="number">3</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    p.b[<span class="number">4</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize with zeroes */</span></span><br><span class="line">    <span class="built_in">memset</span>(p.f, <span class="number">0</span>, <span class="built_in">sizeof</span>(p.f));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (_vehicle-&gt;<span class="built_in">vehicleType</span>()) &#123;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* direct pass-through, normal fixed-wing. */</span></span><br><span class="line">            <span class="comment">//p.f[0] = -ctl_1;        ///&lt; X-Plane Elevator</span></span><br><span class="line">            <span class="comment">//p.f[1] = ctl_0;         ///&lt; X-Plane Aileron</span></span><br><span class="line">            <span class="comment">//p.f[2] = ctl_2;         ///&lt; X-Plane Rudder</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//bfaner--xplane send actuator</span></span><br><span class="line">            p.f[<span class="number">0</span>] = ctl_0;</span><br><span class="line">            p.f[<span class="number">1</span>] = ctl_1;</span><br><span class="line">            p.f[<span class="number">2</span>] = ctl_2;</span><br><span class="line">            p.f[<span class="number">3</span>] = ctl_3;</span><br><span class="line">            p.f[<span class="number">4</span>] = ctl_4;</span><br><span class="line">            p.f[<span class="number">5</span>] = ctl_5;</span><br><span class="line">            p.f[<span class="number">6</span>] = ctl_6;</span><br><span class="line">            p.f[<span class="number">7</span>] = ctl_7;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Send to group 8, which equals manual controls */</span></span><br><span class="line">            p.index = <span class="number">8</span>;</span><br><span class="line">            <span class="built_in">writeBytesSafe</span>((<span class="type">const</span> <span class="type">char</span>*)&amp;p, <span class="built_in">sizeof</span>(p));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Send throttle to all eight motors */</span></span><br><span class="line">            p.index = <span class="number">25</span>;</span><br><span class="line">            p.f[<span class="number">0</span>] = ctl_3;</span><br><span class="line">            p.f[<span class="number">1</span>] = ctl_3;</span><br><span class="line">            p.f[<span class="number">2</span>] = ctl_3;</span><br><span class="line">            p.f[<span class="number">3</span>] = ctl_3;</span><br><span class="line">            p.f[<span class="number">4</span>] = ctl_3;</span><br><span class="line">            p.f[<span class="number">5</span>] = ctl_3;</span><br><span class="line">            p.f[<span class="number">6</span>] = ctl_3;</span><br><span class="line">            p.f[<span class="number">7</span>] = ctl_3;</span><br><span class="line">            <span class="built_in">writeBytesSafe</span>((<span class="type">const</span> <span class="type">char</span>*)&amp;p, <span class="built_in">sizeof</span>(p));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Send flap signals, assuming that they are mapped to channel 5 (ctl_4) */</span></span><br><span class="line"><span class="comment">//            sendDataRef(&quot;sim/flightmodel/controls/flaprqst&quot;, ctl_4);</span></span><br><span class="line"><span class="comment">//            sendDataRef(&quot;sim/flightmodel/controls/flap2rqst&quot;, ctl_4);</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QGCXPlaneLink.cc</span></span><br><span class="line"><span class="built_in">writeBytesSafe</span>((<span class="type">const</span> <span class="type">char</span>*)&amp;p, <span class="built_in">sizeof</span>(p));</span><br><span class="line"><span class="comment">// QGCXPlaneLink.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QGCXPlaneLink</span> : <span class="keyword">public</span> QGCHilLink;</span><br><span class="line"><span class="comment">// QGCHilLink.h</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">writeBytesSafe</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* data, <span class="type">int</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    emit _invokeWriteBytes(<span class="built_in">QByteArray</span>(data, length));</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">QGCHilLink</span>() : <span class="built_in">QThread</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QGCHilLink::_invokeWriteBytes, <span class="keyword">this</span>, &amp;QGCHilLink::_writeBytes);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//QGCXPlaneLink.cc</span></span><br><span class="line"><span class="type">void</span> QGCXPlaneLink::_writeBytes(<span class="type">const</span> QByteArray data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="built_in">isEmpty</span>()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// If socket exists and is connected, transmit the data</span></span><br><span class="line">    <span class="keyword">if</span> (socket &amp;&amp; connectState)</span><br><span class="line">    &#123;</span><br><span class="line">        socket-&gt;<span class="built_in">writeDatagram</span>(data, remoteHost, remotePort);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="HIL相关的mavlink定义"><a href="#HIL相关的mavlink定义" class="headerlink" title="HIL相关的mavlink定义"></a>HIL相关的mavlink定义</h3><p>libs\mavlink\include\mavlink\v2.0\common\mavlink_msg_hil_state_quaternion.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAVLINK_MSG_ID_HIL_STATE_QUATERNION 115</span></span><br></pre></td></tr></table></figure>
<p>libs\mavlink\include\mavlink\v2.0\common\mavlink_msg_hil_actuator_controls.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAVLINK_MSG_ID_HIL_ACTUATOR_CONTROLS 93</span></span><br></pre></td></tr></table></figure>
<p><img src="fb19/image-20230414015837944.png" alt="image-20230414015837944" style="zoom:80%;" /></p>
<h1 id="V4-1-7-左侧菜单栏"><a href="#V4-1-7-左侧菜单栏" class="headerlink" title="V4.1.7-左侧菜单栏"></a>V4.1.7-左侧菜单栏</h1><p>在添加菜单的<code>FlyViewToolStripActionList.qml</code>里，通过报错的路径可以很快查看到函数的执行流程。（qml调试一直出错，无法通过调试看到堆栈）</p>
<p><img src="fb19/image-20230416160438510.png" alt="image-20230416160438510" style="zoom:50%;" /></p>
<h3 id="main-cc初始化"><a href="#main-cc初始化" class="headerlink" title="main.cc初始化"></a><code>main.cc</code>初始化</h3><p>这里与V3.5.6创建一致，行数不一样</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span>  </span>&#123; </span><br><span class="line">    QGCApplication* app = <span class="keyword">new</span> <span class="built_in">QGCApplication</span>(argc, argv, runUnitTests);<span class="comment">//line349</span></span><br><span class="line">    <span class="keyword">if</span> (!app-&gt;_initForNormalAppBoot()) &#123;<span class="comment">//line398</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h3 id="QGCApplication-cc初始化主界面"><a href="#QGCApplication-cc初始化主界面" class="headerlink" title="QGCApplication.cc初始化主界面"></a><code>QGCApplication.cc</code>初始化主界面</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> QGCApplication::_initForNormalAppBoot()</span><br><span class="line">&#123;<span class="comment">//line617</span></span><br><span class="line">    _qmlAppEngine = <span class="built_in">toolbox</span>()-&gt;<span class="built_in">corePlugin</span>()-&gt;<span class="built_in">createQmlApplicationEngine</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">toolbox</span>()-&gt;<span class="built_in">corePlugin</span>()-&gt;<span class="built_in">createRootWindow</span>(_qmlAppEngine);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="QGCCorePlugin-cc加载QML主界面"><a href="#QGCCorePlugin-cc加载QML主界面" class="headerlink" title="QGCCorePlugin.cc加载QML主界面"></a><code>QGCCorePlugin.cc</code>加载QML主界面</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QQmlApplicationEngine* <span class="title">QGCCorePlugin::createQmlApplicationEngine</span><span class="params">(QObject* parent)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//line370</span></span><br><span class="line">    QQmlApplicationEngine* qmlEngine = <span class="keyword">new</span> <span class="built_in">QQmlApplicationEngine</span>(parent);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//添加目录路径：qgroundcontrol.qrc/qml</span></span><br><span class="line">    qmlEngine-&gt;<span class="built_in">addImportPath</span>(<span class="string">&quot;qrc:/qml&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注册了一个名为“joystickManager”的 QML上下文的全局可见属性， 能在QML中调用(QML调用C++的一种形式)</span></span><br><span class="line">    qmlEngine-&gt;<span class="built_in">rootContext</span>()-&gt;<span class="built_in">setContextProperty</span>(<span class="string">&quot;joystickManager&quot;</span>, <span class="built_in">qgcApp</span>()-&gt;<span class="built_in">toolbox</span>()-&gt;<span class="built_in">joystickManager</span>());</span><br><span class="line">    qmlEngine-&gt;<span class="built_in">rootContext</span>()-&gt;<span class="built_in">setContextProperty</span>(<span class="string">&quot;debugMessageModel&quot;</span>, AppMessages::<span class="built_in">getModel</span>());</span><br><span class="line">    <span class="keyword">return</span> qmlEngine;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QGCCorePlugin::createRootWindow</span><span class="params">(QQmlApplicationEngine* qmlEngine)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//line385</span></span><br><span class="line">    <span class="comment">//加载url的QML根文件，立即创建了由本地文件urls定义的对象树。此为UI显示的根目录</span></span><br><span class="line">    qmlEngine-&gt;<span class="built_in">load</span>(<span class="built_in">QUrl</span>(<span class="built_in">QStringLiteral</span>(<span class="string">&quot;qrc:/qml/MainRootWindow.qml&quot;</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="fb19/image-20230416182224592.png" alt="image-20230416182224592" style="zoom:25%;" /></p>
<h3 id="MainRootwindow-qml显示主界面"><a href="#MainRootwindow-qml显示主界面" class="headerlink" title="MainRootwindow.qml显示主界面"></a><code>MainRootwindow.qml</code>显示主界面</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">ApplicationWindow &#123;</span><br><span class="line">    id:             mainWindow</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//界面与菜单栏切换的函数</span></span><br><span class="line">    <span class="function">function <span class="title">viewSwitch</span><span class="params">(currentToolbar)</span> </span>&#123;<span class="comment">//line126</span></span><br><span class="line">        toolDrawer.visible      = <span class="literal">false</span></span><br><span class="line">        toolDrawer.toolSource   = <span class="string">&quot;&quot;</span></span><br><span class="line">        flightView.visible      = <span class="literal">false</span></span><br><span class="line">        planView.visible        = <span class="literal">false</span></span><br><span class="line">        planView.visible        = <span class="literal">false</span></span><br><span class="line">        toolbar.currentToolbar  = currentToolbar</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function <span class="built_in">showFlyView</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (!flightView.visible) &#123;</span><br><span class="line">            mainWindow.<span class="built_in">showPreFlightChecklistIfNeeded</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">viewSwitch</span>(toolbar.flyViewToolbar)</span><br><span class="line">        flightView.visible = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function <span class="built_in">showPlanView</span>() &#123;</span><br><span class="line">        <span class="built_in">viewSwitch</span>(toolbar.planViewToolbar)</span><br><span class="line">        planView.visible = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function <span class="built_in">showTool</span>(toolTitle, toolSource, toolIcon) &#123;</span><br><span class="line">        toolDrawer.backIcon     = flightView.visible ? <span class="string">&quot;/qmlimages/PaperPlane.svg&quot;</span> : <span class="string">&quot;/qmlimages/Plan.svg&quot;</span></span><br><span class="line">        toolDrawer.toolTitle    = toolTitle</span><br><span class="line">        toolDrawer.toolSource   = toolSource</span><br><span class="line">        toolDrawer.toolIcon     = toolIcon</span><br><span class="line">        toolDrawer.visible      = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function <span class="built_in">showAnalyzeTool</span>() &#123;</span><br><span class="line">        <span class="built_in">showTool</span>(<span class="built_in">qsTr</span>(<span class="string">&quot;Analyze Tools&quot;</span>), <span class="string">&quot;AnalyzeView.qml&quot;</span>, <span class="string">&quot;/qmlimages/Analyze.svg&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function <span class="built_in">showSetupTool</span>() &#123;</span><br><span class="line">        <span class="built_in">showTool</span>(<span class="built_in">qsTr</span>(<span class="string">&quot;Vehicle Setup&quot;</span>), <span class="string">&quot;SetupView.qml&quot;</span>, <span class="string">&quot;/qmlimages/Gears.svg&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function <span class="built_in">showSettingsTool</span>() &#123;</span><br><span class="line">        <span class="built_in">showTool</span>(<span class="built_in">qsTr</span>(<span class="string">&quot;Application Settings&quot;</span>), <span class="string">&quot;AppSettings.qml&quot;</span>, <span class="string">&quot;/res/QGCLogoWhite&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//加载各界面，默认界面为FlyView</span></span><br><span class="line">    FlyView &#123;<span class="comment">//line465</span></span><br><span class="line">        id:             flightView</span><br><span class="line">        anchors.fill:   parent</span><br><span class="line">    &#125;</span><br><span class="line">    PlanView &#123;</span><br><span class="line">        id:             planView</span><br><span class="line">        anchors.fill:   parent</span><br><span class="line">        visible:        <span class="literal">false</span><span class="comment">//不可见</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Flyview-qml加载小工具层"><a href="#Flyview-qml加载小工具层" class="headerlink" title="Flyview.qml加载小工具层"></a><code>Flyview.qml</code>加载小工具层</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FlyViewWidgetLayer &#123;<span class="comment">//line77</span></span><br><span class="line">    id:                     widgetLayer</span><br><span class="line">    anchors.top:            parent.top</span><br><span class="line">    anchors.bottom:         parent.bottom</span><br><span class="line">    anchors.left:           parent.left</span><br><span class="line">    anchors.right:          guidedAltSlider.visible ? guidedAltSlider.left : parent.right</span><br><span class="line">    z:                      _fullItemZorder + <span class="number">1</span></span><br><span class="line">    parentToolInsets:       _toolInsets</span><br><span class="line">    mapControl:             _mapControl</span><br><span class="line">    visible:                !QGroundControl.videoManager.fullScreen</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="FlyViewWidgetLayer-qml加载工具栏"><a href="#FlyViewWidgetLayer-qml加载工具栏" class="headerlink" title="FlyViewWidgetLayer.qml加载工具栏"></a><code>FlyViewWidgetLayer.qml</code>加载工具栏</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FlyViewToolStrip &#123;<span class="comment">//line192</span></span><br><span class="line">    id:                     toolStrip</span><br><span class="line">    anchors.leftMargin:     _toolsMargin + parentToolInsets.leftEdgeCenterInset</span><br><span class="line">    anchors.topMargin:      _toolsMargin + parentToolInsets.topEdgeLeftInset</span><br><span class="line">    anchors.left:           parent.left</span><br><span class="line">    anchors.top:            parent.top</span><br><span class="line">    z:                      QGroundControl.zOrderWidgets</span><br><span class="line">    maxHeight:              parent.height - y - parentToolInsets.bottomEdgeLeftInset - _toolsMargin</span><br><span class="line">    visible:                !QGroundControl.videoManager.fullScreen</span><br><span class="line"></span><br><span class="line">    onDisplayPreFlightChecklist: mainWindow.<span class="built_in">showPopupDialogFromComponent</span>(preFlightChecklistPopup)</span><br><span class="line"></span><br><span class="line">    property real leftInset: x + width</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="FlyViewToolStrip-qml加载工具栏模型"><a href="#FlyViewToolStrip-qml加载工具栏模型" class="headerlink" title="FlyViewToolStrip.qml加载工具栏模型"></a><code>FlyViewToolStrip.qml</code>加载工具栏模型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ToolStrip &#123;</span><br><span class="line">    id:     _root</span><br><span class="line">    title:  <span class="built_in">qsTr</span>(<span class="string">&quot;Fly&quot;</span>)</span><br><span class="line"></span><br><span class="line">    signal displayPreFlightChecklist</span><br><span class="line"></span><br><span class="line">    FlyViewToolStripActionList &#123;</span><br><span class="line">        id: flyViewToolStripActionList</span><br><span class="line"></span><br><span class="line">        onDisplayPreFlightChecklist: _root.<span class="built_in">displayPreFlightChecklist</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    model: flyViewToolStripActionList.model</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="FlyViewToolStripActionList-qml加载工具栏列表"><a href="#FlyViewToolStripActionList-qml加载工具栏列表" class="headerlink" title="FlyViewToolStripActionList.qml加载工具栏列表"></a><code>FlyViewToolStripActionList.qml</code>加载工具栏列表</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ToolStripActionList &#123;</span><br><span class="line">    id: _root</span><br><span class="line"></span><br><span class="line">    signal displayPreFlightChecklist</span><br><span class="line"></span><br><span class="line">    model: [</span><br><span class="line">        ToolStripAction &#123;</span><br><span class="line">            text:           <span class="built_in">qsTr</span>(<span class="string">&quot;Plan&quot;</span>)</span><br><span class="line">            iconSource:     <span class="string">&quot;/qmlimages/Plan.svg&quot;</span></span><br><span class="line">            onTriggered:    mainWindow.<span class="built_in">showPlanView</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        PreFlightCheckListShowAction &#123; onTriggered: <span class="built_in">displayPreFlightChecklist</span>() &#125;,</span><br><span class="line">        GuidedActionTakeoff &#123; &#125;,</span><br><span class="line">        GuidedActionLand &#123; &#125;,</span><br><span class="line">        GuidedActionRTL &#123; &#125;,</span><br><span class="line">        GuidedActionPause &#123; &#125;,</span><br><span class="line">        GuidedActionActionList &#123; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GuidedActionLand-qml菜单页面"><a href="#GuidedActionLand-qml菜单页面" class="headerlink" title="GuidedActionLand.qml菜单页面"></a><code>GuidedActionLand.qml</code>菜单页面</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">QGroundControl</span>.<span class="property">FlightDisplay</span> <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">GuidedToolStripAction</span> &#123;</span><br><span class="line">    <span class="attr">text</span>:       _guidedController.<span class="property">landTitle</span></span><br><span class="line">    <span class="attr">message</span>:    _guidedController.<span class="property">landMessage</span></span><br><span class="line">    <span class="attr">iconSource</span>: <span class="string">&quot;/res/land.svg&quot;</span></span><br><span class="line">    <span class="attr">visible</span>:    _guidedController.<span class="property">showLand</span> &amp;&amp; !_guidedController.<span class="property">showTakeoff</span></span><br><span class="line">    <span class="attr">enabled</span>:    _guidedController.<span class="property">showLand</span></span><br><span class="line">    <span class="attr">actionID</span>:   _guidedController.<span class="property">actionLand</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GuidedActionsController-qml菜单控制"><a href="#GuidedActionsController-qml菜单控制" class="headerlink" title="GuidedActionsController.qml菜单控制"></a><code>GuidedActionsController.qml</code>菜单控制</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">readonly property string <span class="attr">landTitle</span>:                      <span class="title function_">qsTr</span>(<span class="string">&quot;Land&quot;</span>)<span class="comment">//line42</span></span><br><span class="line">readonly property string <span class="attr">landMessage</span>:                    <span class="title function_">qsTr</span>(<span class="string">&quot;Land the vehicle at the current position.&quot;</span>)<span class="comment">//line67</span></span><br><span class="line">    </span><br><span class="line">readonly property int <span class="attr">actionLand</span>:                        <span class="number">2</span><span class="comment">//line82</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">confirmAction</span>(<span class="params">actionCode, actionData, mapIndicator</span>) &#123;<span class="comment">//line386,确认框</span></span><br><span class="line">    <span class="keyword">var</span> showImmediate = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">closeAll</span>()</span><br><span class="line">    confirmDialog.<span class="property">action</span> = actionCode</span><br><span class="line">    confirmDialog.<span class="property">actionData</span> = actionData</span><br><span class="line">    confirmDialog.<span class="property">hideTrigger</span> = <span class="literal">true</span></span><br><span class="line">    confirmDialog.<span class="property">mapIndicator</span> = mapIndicator</span><br><span class="line">    confirmDialog.<span class="property">optionText</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    _actionData = actionData</span><br><span class="line">    <span class="keyword">switch</span> (actionCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="attr">actionLand</span>:</span><br><span class="line">            confirmDialog.<span class="property">title</span> = landTitle</span><br><span class="line">            confirmDialog.<span class="property">message</span> = landMessage</span><br><span class="line">            confirmDialog.<span class="property">hideTrigger</span> = <span class="title class_">Qt</span>.<span class="title function_">binding</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> !showLand &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    confirmDialog.<span class="title function_">show</span>(showImmediate)<span class="comment">//显示滑动框</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">executeAction</span>(<span class="params">actionCode, actionData, actionAltitudeChange, optionChecked</span>) &#123;<span class="comment">//line466,执行函数</span></span><br><span class="line">    <span class="keyword">var</span> i;</span><br><span class="line">    <span class="keyword">var</span> rgVehicle;</span><br><span class="line">    <span class="keyword">switch</span> (actionCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="attr">actionLand</span>:</span><br><span class="line">            _activeVehicle.<span class="title function_">guidedModeLand</span>()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="小工具响应函数"><a href="#小工具响应函数" class="headerlink" title="小工具响应函数"></a>小工具响应函数</h2><p><code>confirmAction</code>和<code>executeAction</code></p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">QGCButton</span> &#123;</span><br><span class="line">    <span class="attribute">id:</span><span class="string">                 actionButton</span></span><br><span class="line">    <span class="attribute">text</span>:               modelData.title</span><br><span class="line">    <span class="attribute">Layout.alignment</span>:   Qt.AlignCenter</span><br><span class="line"></span><br><span class="line">    <span class="attribute">onClicked</span>: &#123;</span><br><span class="line">        _root.visible = <span class="literal">false</span></span><br><span class="line">        guidedController.confirmAction(modelData.action)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://bfaner.github.io">帆小生</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://bfaner.github.io/posts/fb19.html">https://bfaner.github.io/posts/fb19.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://bfaner.github.io" target="_blank">BFaner</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/cover.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/8948.html"><img class="prev-cover" src="/img/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">混控器</div></div></a></div><div class="next-post pull-right"><a href="/posts/184.html"><img class="next-cover" src="/img/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">小扰动方程与状态矩阵</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">帆小生</div><div class="author-info__description">Because we can</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Bfaner"><i class="fab fa-github"></i><span>联系我</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%8E%B7%E5%8F%96"><span class="toc-number">1.</span> <span class="toc-text">代码获取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E5%8C%85"><span class="toc-number">1.1.</span> <span class="toc-text">编译安装包</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">日志处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#filghtplot"><span class="toc-number">2.1.</span> <span class="toc-text">filghtplot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pyulog%E8%BD%ACexcel%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">pyulog转excel文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AE%B0%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">代码记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#V3-5-6-HIL%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">V3.5.6-HIL启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main-cc%E4%B8%AD%E5%88%9B%E5%BB%BA%E7%95%8C%E9%9D%A2"><span class="toc-number">3.1.1.</span> <span class="toc-text">main.cc中创建界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QGCApplication-cc%E4%B8%AD%E5%88%9D%E5%A7%8B%E5%8C%96%E5%90%84%E7%95%8C%E9%9D%A2"><span class="toc-number">3.1.2.</span> <span class="toc-text">QGCApplication.cc中初始化各界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MainWindow-cc%E5%88%9B%E5%BB%BAMainWindow"><span class="toc-number">3.1.3.</span> <span class="toc-text">MainWindow.cc创建MainWindow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%8F%9C%E5%8D%95%E9%87%8C%E7%9A%84%E5%B0%8F%E9%83%A8%E4%BB%B6"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">创建菜单里的小部件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAHIL%E5%B0%8F%E7%AA%97%E5%8F%A3"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">新建HIL小窗口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6UDP"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">接收UDP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81mavlink"><span class="toc-number">3.1.3.4.</span> <span class="toc-text">发送mavlink</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6mavlink"><span class="toc-number">3.1.3.5.</span> <span class="toc-text">接收mavlink</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81UDP"><span class="toc-number">3.1.3.6.</span> <span class="toc-text">发送UDP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HIL%E7%9B%B8%E5%85%B3%E7%9A%84mavlink%E5%AE%9A%E4%B9%89"><span class="toc-number">3.1.4.</span> <span class="toc-text">HIL相关的mavlink定义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#V4-1-7-%E5%B7%A6%E4%BE%A7%E8%8F%9C%E5%8D%95%E6%A0%8F"><span class="toc-number">4.</span> <span class="toc-text">V4.1.7-左侧菜单栏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main-cc%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.0.1.</span> <span class="toc-text">main.cc初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QGCApplication-cc%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%BB%E7%95%8C%E9%9D%A2"><span class="toc-number">4.0.2.</span> <span class="toc-text">QGCApplication.cc初始化主界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QGCCorePlugin-cc%E5%8A%A0%E8%BD%BDQML%E4%B8%BB%E7%95%8C%E9%9D%A2"><span class="toc-number">4.0.3.</span> <span class="toc-text">QGCCorePlugin.cc加载QML主界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MainRootwindow-qml%E6%98%BE%E7%A4%BA%E4%B8%BB%E7%95%8C%E9%9D%A2"><span class="toc-number">4.0.4.</span> <span class="toc-text">MainRootwindow.qml显示主界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flyview-qml%E5%8A%A0%E8%BD%BD%E5%B0%8F%E5%B7%A5%E5%85%B7%E5%B1%82"><span class="toc-number">4.0.5.</span> <span class="toc-text">Flyview.qml加载小工具层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FlyViewWidgetLayer-qml%E5%8A%A0%E8%BD%BD%E5%B7%A5%E5%85%B7%E6%A0%8F"><span class="toc-number">4.0.5.1.</span> <span class="toc-text">FlyViewWidgetLayer.qml加载工具栏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FlyViewToolStrip-qml%E5%8A%A0%E8%BD%BD%E5%B7%A5%E5%85%B7%E6%A0%8F%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.0.5.2.</span> <span class="toc-text">FlyViewToolStrip.qml加载工具栏模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FlyViewToolStripActionList-qml%E5%8A%A0%E8%BD%BD%E5%B7%A5%E5%85%B7%E6%A0%8F%E5%88%97%E8%A1%A8"><span class="toc-number">4.0.5.3.</span> <span class="toc-text">FlyViewToolStripActionList.qml加载工具栏列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GuidedActionLand-qml%E8%8F%9C%E5%8D%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">4.0.5.4.</span> <span class="toc-text">GuidedActionLand.qml菜单页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GuidedActionsController-qml%E8%8F%9C%E5%8D%95%E6%8E%A7%E5%88%B6"><span class="toc-number">4.0.5.5.</span> <span class="toc-text">GuidedActionsController.qml菜单控制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E5%B7%A5%E5%85%B7%E5%93%8D%E5%BA%94%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.</span> <span class="toc-text">小工具响应函数</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 帆小生</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>